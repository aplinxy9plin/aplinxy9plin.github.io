"use strict";function setText(e,t){var n;for(n=0;n<document.querySelectorAll("[data-text='"+e+"']").length;n++)document.querySelectorAll("[data-text='"+e+"']")[n].textContent=t}function getText(e){var t;for(t in _texts)if(e==t)return _texts[t];return null}function trace(e){"undefined"!=typeof console&&console.log(e)}function clearInput(e){e.value==e.defaultValue&&(e.value="")}function resetInput(e){""==e.value&&(e.value=e.defaultValue)}function jsonToString(e){return JSON.stringify(e)}function validateEmail(e){var t=e.indexOf("@"),n=e.lastIndexOf(".");return!(t<1||n<t+2||n+2>=e.length)}function startLoading(){$("#loading").css({display:"table"})}function stopLoading(){$("#loading").hide()}function getScrollOffsets(e){if(null!=(e=e||window).pageXOffset)return{x:e.pageXOffset,y:e.pageYOffset};var t=e.document;return"CSS1Compat"==document.compatMode?{x:t.documentElement.scrollLeft,y:t.documentElement.scrollTop}:{x:t.body.scrollLeft,y:t.body.scrollTop}}function scrollToTop(){$("html, body").animate({scrollTop:0},300)}function excerpt(e,t){return null==e?"undefined":(e.length>t&&(e=e.substr(0,t)+"..."),e)}function isIeLowerThan(e){if(document.documentMode)return!(document.documentMode>=e);for(var t=7;0<t;t--){var n=document.createElement("div");if(n.innerHTML="<!--[if IE "+t+"]><span></span><![endif]-->",n.getElementsByTagName("span").length)return!(e<=t)}return!1}function showPasswordInput(e,t){e.style.display="none";var n=document.getElementById(t);n.style.display="inline",n.focus()}function isUndefined(e){return void 0===e}function getAndroidVersion(e){var t=(e=(e||navigator.userAgent).toLowerCase()).match(/android\s([0-9\.]*)/);return!!t&&t[1]}function getLanguage(){var e=navigator.language||navigator.userLanguage;alert("The language is: "+e)}function gestureChange(e){1!==(e=e.originalEvent||e).scale&&(e.preventDefault(),_body.style.transform="scale(1)")}function addToMainLog(e){if(_isDebug){var t=document.getElementById("mainLog");t.innerHTML=e+"<br/>"+t.innerHTML}}function addToLog(e){_isDebug&&(console.log(e),addToMainLog(e))}function ar(e){this.scenesJson=e.scenesData,this.nbScenes=this.scenesJson.length,this.data=null,this.currentMode="ar",this.projectFolder=null,this.isDebug=!1,this.renderer=null,this.rootOrientation=null,this.rootModel=null,this.mixer=null,this.activeAnimationIndex=-1,this.arController=null,this.p_markerRoot=null,this.sceneData=[],this.object=null,this.ambientLight=null,this.light=[],this.textures=[],this.nbTextureFiles=0,this.currentTextureFileIndex=0,this.timerHelp=null,this.clock=null,this.firstTimeFound=!0,this.audioListener=null,this.sound=null,this.soundVolume=1,this.envMap=null,this.indexSceneCurrent=0,this.indexSceneLoading=0,this.needPlayButton=!1,this.prevCurrentMarkerVisible=!1,this.multipleTracking=!1,e.settings&&e.settings.multiScene&&e.settings.multiScene.multiMarkers&&1==e.settings.multiScene.multiMarkers&&(this.multipleTracking=!0),this.setNewData=function(e){addToLog("setNewdata "+e);var t=this;t.data=t.scenesJson[e],t.needPlayButton=!1,t.envMap=null,t.pauseAllVideoTextures(),null==t.data.settings.lighting.root&&(addToLog("OBS: create lighting.root"),t.data.settings.lighting.root={transform:{ar:{scale:{xyz:1}},vr:{scale:{xyz:1}}}}),t.projectFolder=_rootDirectory+"s/"+t.data.folder+"/"+t.data.url+"/",null!=t.data.settings.vertical&&(_isVertical=t.data.settings.vertical,setOrientation()),null==t.data.settings.orientationSelector&&(t.data.settings.orientationSelector=1),0==t.data.settings.orientationSelector&&$("#orientation ul").css("display:none"),t.indexSceneLoading=e,t.sceneData[t.indexSceneLoading]={},t.sceneData[t.indexSceneLoading].data=JSON.parse(JSON.stringify(t.data)),t.sceneData[t.indexSceneLoading].materialsLinks=t.data.materialsLinks,t.sceneData[t.indexSceneLoading].rootXR=new THREE.Group,t.sceneData[t.indexSceneLoading].rootOrientation=new THREE.Group,t.sceneData[t.indexSceneLoading].rootOrientation.name="R O "+t.indexSceneLoading,t.sceneData[t.indexSceneLoading].rootModel=new THREE.Group,t.sceneData[t.indexSceneLoading].rootLighting=null},this.allSceneDataLoaded=function(){var n=this;addToLog(">> allSceneDataLoaded "+n.indexSceneLoading+" / "+n.nbScenes);var a=n.sceneData[n.indexSceneLoading].data.settings.audio;a&&(a.sounds&&-1!=a.activeIndex&&(n.needPlayButton=!0));if(n.needPlayButton&&($("#playPanel").css("display:block;"),$("body").addClass("playPanel"),$("#playPanel").on(_clickOrTouch,function(){$("#playPanel").css("display:none;"),$("body").removeClass("playPanel");var e=document.querySelector(".videoTexture");if(e)if(_isDebug&&console.log("fake start video +"),is.ios(arguments)){var t=e.play();void 0!==t&&t.then(function(){e.pause()}).catch(function(){console.log("auto play prevented")})}else e.play(),e.pause();n.sound||console.log("WARNING: sound not ready or no sound"),n.sound?(n.sound.isPlaying&&n.sound.stop(),n.sound.play(),n.sound.setVolume(0),setTimeout(function(){a.noMarker||_body.classList.contains("m")||n.sound.stop(),n.sound.setVolume(1)},50)):addToLog("c.sound is null")})),n.indexSceneLoading!=n.indexSceneCurrent&&1!=n.multipleTracking||n.selectScene(n.indexSceneLoading),$("#sceneLoader").css("display:none;"),n.onARReady(),null!=document.querySelectorAll("#sceneSelector li")){var e=document.querySelectorAll("#sceneSelector li")[n.indexSceneLoading];e&&(e.style.visibility="visible")}n.indexSceneLoading+1<n.nbScenes&&(n.indexSceneLoading++,n.setNewData(n.indexSceneLoading),"img"==n.sceneData[n.indexSceneLoading].data.model.type?n.initSceneImage():loadAB(n))},this.selectScene=function(e){var t=this;if(addToLog("- - selectScene "+e+" - -"),t.pauseAllVideoTextures(),!t.multipleTracking)if(t.p_markerRoot)for(;0<t.p_markerRoot.children.length;)t.p_markerRoot.remove(t.p_markerRoot.children[0]);else console.log("X X X X previous scene has no marker root pointer");t.indexSceneCurrent=e;var n,a=t.sceneData[t.indexSceneCurrent],o=a.data;if(t.multipleTracking){var i,r,s,l=document.querySelector(".pattern ul.patternPreviews");u=document.querySelector("#help ul.patternPreviews");for(l.classList.add("x"+t.sceneData.length),l.innerHTML="",u.innerHTML="",i=0;i<t.sceneData.length;i++)r=document.createElement("li"),n=_rootDirectory+"assets/xrplus-marker-512.png",(s=t.sceneData[i].data.pattern).id&&(n=_rootDirectory+"p/"+s.folder+"/"+s.id+"/"+s.url),r.innerHTML='<img src="'+n+'" alt=""/>',l.appendChild(r),(c=document.createElement("li")).setAttribute("data-img",n),c.innerHTML='<img src="'+n+'" alt=""/>',u.appendChild(c),c.addEventListener(_clickOrTouch,function(){var e=this.getAttribute("data-img");document.querySelector("#patternLarge .patternPreview").src=e,document.getElementById("patternLarge").style.display="block"})}else{var d,c,u;for(n=_rootDirectory+"assets/xrplus-marker-512.png",o.pattern.id&&(n=_rootDirectory+"p/"+o.pattern.folder+"/"+o.pattern.id+"/"+o.pattern.url),d=0;d<document.querySelectorAll(".patternPreview").length;d++)document.querySelectorAll(".patternPreview")[d].src=n;(c=document.createElement("li")).setAttribute("data-img",n),c.innerHTML='<img src="'+n+'" alt=""/>',(u=document.querySelector("#help ul.patternPreviews")).appendChild(c),c.addEventListener(_clickOrTouch,function(){document.getElementById("patternLarge").style.display="block"})}if(t.p_markerRoot=a.markerRoot,null==t.p_markerRoot)for(i=0;i<t.sceneData.length;i++)if(t.sceneData[i].data.pattern.id==o.pattern.id){t.p_markerRoot=t.sceneData[i].markerRoot;break}for(;0<t.p_markerRoot.children.length;)t.p_markerRoot.remove(t.p_markerRoot.children[0]);for(_arScene.scene.add(t.p_markerRoot),t.p_markerRoot.add(a.rootOrientation),a.rootOrientation.add(a.rootXR),a.rootXR.add(a.rootModel);0<a.rootModel.children.length;)a.rootModel.remove(a.rootModel.children[0]);if(t.rootLighting=a.rootLighting,t.addObject(),t.setupLighting(),t.setupMaterials(),t.setupAnimations(),t.setOrientation(),_body.classList.contains("m")&&o.settings.animations){var m=o.settings.animations.activeIndex;t.playAnimation(m)}},this.onARReady=function(){addToLog("onARReady");$("#access").css("display:none"),this.streamResized(),this.startLoop()},this.initScene=function(e){addToLog("initScene "+e);var t=this,n=!0;if(is.android(arguments)&&is.firefox(arguments)&&(n=!1),t.renderer=new THREE.WebGLRenderer({antialias:!0,preserveDrawingBuffer:!0,canvas:_canvas,logarithmicDepthBuffer:n}),is.ios(arguments)&&t.renderer.setPixelRatio(2),is.android(arguments)&&!is.windowsPhone(arguments))try{5<=parseInt(getAndroidVersion(),10)&&t.renderer.setPixelRatio(2)}catch(e){addToLog("getAndroidVersion error")}var a=window.innerWidth,o=window.innerHeight;t.renderer.setSize(a,o),window.addEventListener("resize",function(){t.resizeCanvas()});var i=document.getElementById("preloader");i&&i.parentElement.removeChild(i),addToLog(">> start load scene all data"),"img"!=t.data.model.type?loadAB(t):t.initSceneImage()},this.initSceneImage=function(){addToLog("initSceneImage");var e=this.data.model.height/this.data.model.width,t=new THREE.PlaneGeometry(1,e),n=new THREE.Mesh(t,null);n.name="image",this.onModelLoaded(n,null,null),this.object.rotateX(THREE.Math.degToRad(-90))},this.updateLoader=function(e){e/=2,$("#fill").css("width:"+e+"%")},this.setHelpVisibility=function(e){var t=this;clearTimeout(t.timerHelp),t.timerHelp=null;var n=t.sceneData[t.indexSceneCurrent].data;if(e)_body.classList.contains("m")&&(_body.classList.remove("m"),t.pauseAllVideoTextures());else if(!_body.classList.contains("m")){if(t.firstTimeFound){if(n.settings.animations){var a=n.settings.animations.activeIndex;t.playAnimation(a)}t.playAudio()}t.firstTimeFound=!1,_body.classList.add("m")}},this.onModelLoaded=function(e,t){var n=this;null!=e?(n.sceneData[n.indexSceneLoading].object=e,n.object=n.sceneData[n.indexSceneLoading].object,n.sceneData[n.indexSceneLoading].animations=t,addToLog("on model loaded"),n.loadTextures()):addToLog("model loaded is NULL")},this.loadTextures=function(){var e=this;e.sceneData[e.indexSceneLoading].textures=[],e.textures=e.sceneData[e.indexSceneLoading].textures;var t,n,a,o=e.data.materials.length;for(t=0;t<o;t++)e.textures.push({}),(a=(n=e.data.materials[t])["colorMap"])&&a.url&&e.nbTextureFiles++,(a=n["normalMap"])&&a.url&&e.nbTextureFiles++,(a=n["metalnessMap"])&&a.url&&e.nbTextureFiles++;0!=e.nbTextureFiles?e.loadTexture(0,"colorMap"):e.onTexturesLoaded()},this.loadTexture=function(t,n){var a=this,e=a.data.materials[t],o=e[n];if("metalnessMap"!=n||"MeshStandardMaterial"==e.type)if(o){var i=a.projectFolder+o.url;if("mp4"==i.substr(i.lastIndexOf(".")+1)){console.log("video audio: "+e.audio);var r=document.createElement("video"),s=!0;e.audio&&1==e.audio&&(console.log("video requires a play button"),s=!1,a.needPlayButton=!0),r.setAttribute("class","videoTexture"),r.setAttribute("height",128),r.setAttribute("width",128),r.setAttribute("data-scene",a.indexSceneLoading),_body.appendChild(r),r.loop=!0,r.playsInline=!0,s&&(r.muted=!0);var l=document.createElement("source");return l.src=i,l.setAttribute("type","video/mp4"),r.appendChild(l),a.textures[t][n]=new THREE.VideoTexture(r),a.textures[t][n].wrapS=a.textures[t][n].wrapT=THREE.RepeatWrapping,a.textures[t][n].minFilter=THREE.LinearFilter,a.textures[t][n].magFilter=THREE.LinearFilter,a.textures[t][n].format=THREE.RGBFormat,a.loadNextTexture(t,n),void a.currentTextureFileIndex++}if(i){var d=new THREE.TextureLoader;a.textures[t][n]=d.load(i,function(e){e.wrapS=e.wrapT=THREE.RepeatWrapping,a.loadNextTexture(t,n),a.currentTextureFileIndex++},function(){},function(){addToLog("error loading texture: "+t+" "+n),a.loadNextTexture(t,n),a.currentTextureFileIndex++})}else a.loadNextTexture(t,n)}else a.loadNextTexture(t,n);else a.loadNextTexture(t,n)},this.loadNextTexture=function(e,t){var n=this,a=100*n.currentTextureFileIndex/n.nbTextureFiles;if(a=50+a/2,document.getElementById("fill").style.width=a+"%","colorMap"!=t){if("normalMap"!=t)return"metalnessMap"==t?++e==n.textures.length?void n.onTexturesLoaded():void n.loadTexture(e,"colorMap"):void 0;n.loadTexture(e,"metalnessMap")}else n.loadTexture(e,"normalMap")},this.onTexturesLoaded=function(){console.log("-> on textures loaded");this.loadAudio()},this.loadAudio=function(){addToLog("-> load audio");var t=this;if(console.log("- - - load audio"),t.audioListener=null,t.data.settings.audio)if(t.data.settings.audio.sounds)if(-1!=t.data.settings.audio.activeIndex){var e=t.projectFolder+t.data.settings.audio.sounds[0].url;t.audioListener=new THREE.AudioListener,t.sound=new THREE.Audio(t.audioListener),(new THREE.AudioLoader).load(e,function(e){t.sound.setBuffer(e),t.onAudioLoaded()})}else t.onAudioLoaded();else t.onAudioLoaded();else t.onAudioLoaded()},this.onAudioLoaded=function(){addToLog("-> on audio loaded"),0==this.indexSceneLoading?window.ARController&&ARController.getUserMediaThreeScene?this.ARThreeOnLoad():(addToLog("ERROR 345"),console.log("ERROR 345")):this.loadMarker()},this.addObject=function(){var e=this,t=e.sceneData[e.indexSceneCurrent],n=t.data;e.object=t.object;var a=n.transform[e.currentMode],o=a.scale.xyz*n.transform.scaleToFit/10;t.rootModel.scale.set(o,o,o),t.rootModel.position.set(a.position.x/10,a.position.y/10,a.position.z/10),t.rootModel.rotation.set(THREE.Math.degToRad(a.rotation.x),THREE.Math.degToRad(a.rotation.y),THREE.Math.degToRad(a.rotation.z)),t.rootModel.add(e.object),t.rootXR.rotation.set(THREE.Math.degToRad(90),0,0)},this.startLoop=function(){var r=this,s=r.sceneData[r.indexSceneCurrent].data;if(r.audioListener&&_arScene.camera.add(r.audioListener),s.settings.tools&&1==s.settings.tools.enabled&&(_tools=new tools(r.sceneData[r.indexSceneCurrent])),"undefined"!=typeof customTools&&customTools(r),null==r.clock){setInterval(function(){r.streamResized()},1e3);addToLog(">> >> start loop"),r.clock=new THREE.Clock;var l=function(e){var t=r.clock.getDelta();if(!_body.classList.contains("playPanel")){var n;_arScene.process(),_arScene.renderOn(r.renderer),r.mixer&&r.mixer.update(t),TWEEN.update(e);var a=!1;if(null==r.p_markerRoot&&console.log("null"),r.multipleTracking){for(n=0;n<r.sceneData.length;n++)if(r.sceneData[n].markerRoot&&r.sceneData[n].markerRoot.visible){a=!0;break}}else r.p_markerRoot.visible&&(a=!0);if(a){if(0==r.prevCurrentMarkerVisible){var o=document.querySelector('.videoTexture[data-scene="'+r.indexSceneCurrent+'"]');if(o)if(_isDebug,is.ios(arguments)){var i=o.play();void 0!==i&&i.then(function(){}).catch(function(){console.log("auto play prevented")})}else o.play()}r.sound&&0==r.prevCurrentMarkerVisible&&(r.sound.isPlaying||r.sound.play()),r.setHelpVisibility(!1)}else null==r.timerHelp&&(r.timerHelp=setTimeout(function(){r.firstTimeFound=!0,r.setHelpVisibility(!0)},1e3));r.sound&&(s.settings.audio.noMarker||(_body.classList.contains("m")?(r.soundVolume=1,r.sound.setVolume(r.soundVolume)):0<r.soundVolume&&(r.soundVolume-=t,r.soundVolume<0&&(r.soundVolume=0),r.sound.setVolume(r.soundVolume)))),r.prevCurrentMarkerVisible=a}requestAnimationFrame(l)};l()}},this.setOrientation=function(){var e=this,t=e.sceneData[e.indexSceneCurrent];if(null!=t){var n,a,o=new THREE.Vector3(0,0,0),i=new THREE.Vector3(0,0,0);if(_isVertical&&(o=new THREE.Vector3(THREE.Math.degToRad(-90),0,0),i=new THREE.Vector3(0,-.5,.5),1==t.data.settings.invertVertical&&(o=new THREE.Vector3(THREE.Math.degToRad(90),0,0)),"img"==t.data.model.type)){i.y+=.5;var r=t.data.model.height/e.data.model.width,s=t.data.transform[e.currentMode].scale.xyz*t.data.transform.scaleToFit/10;i.z=r*s/2}for(n=0;n<e.sceneData.length;n++)if(e.sceneData[n].rootOrientation){a=e.sceneData[n].rootOrientation;new TWEEN.Tween(a.rotation).to(o,200).start(),new TWEEN.Tween(a.position).to(i,200).start()}}},this.setupMaterials=function(){var t=this,e=t.sceneData[t.indexSceneCurrent].object,n=0;e.geometry&&t.setupMaterial(t.object,n),n=1,e.traverse(function(e){e.geometry&&e.geometry.attributes&&t.setupMaterial(e,n),n++}),null!=t.data.settings.envMap&&t.setupEnvMap(t.data.settings.envMap.index)},this.setupLighting=function(){var e=this,t=e.sceneData[e.indexSceneCurrent];if(e.rootLighting)for(;0<e.rootLighting.children.length;)e.rootLighting.remove(e.rootLighting.children[0]);if(null!=t.data.settings.lighting.enableModelLights&&e.object.traverse(function(e){"PointLight"!=e.type&&"SpotLight"!=e.type||(e.visible=t.data.settings.lighting.enableModelLights)}),!t.data.settings.lighting.unlit){e.rootLighting=new THREE.Group,t.rootXR.add(e.rootLighting);var n,a=t.data.settings.lighting,o=a.root.transform[e.currentMode].scale.xyz;e.ambientLight=new THREE.AmbientLight,e.ambientLight.intensity=a.ambient.intensity,e.ambientLight.color=new THREE.Color(a.ambient.color),e.rootLighting.add(e.ambientLight);for(n=0;n<3;n++)e.light[n]=new THREE.PointLight,e.light[n].color=new THREE.Color(a.lights[n].color),e.light[n].intensity=a.lights[n].intensity,e.light[n].position.set(a.lights[n].position.x*o,a.lights[n].position.y*o,a.lights[n].position.z*o),e.rootLighting.add(e.light[n])}},this.setupEnvMap=function(e){var t=this;if(0!=e){t.renderer.gammaInput=!0,t.renderer.gammaOutput=!0,t.renderer.toneMapping=THREE.NoToneMapping,t.renderer.toneMappingExposure=1;var n=_rootDirectory+"assets/textures/envmap"+e+".jpg";null==t.envMap?t.envMap=(new THREE.TextureLoader).load(n,function(){t.envMap.mapping=THREE.SphericalReflectionMapping,t.object.traverse(function(e){e.geometry&&e.material&&(e.material.envMap=t.envMap,"MeshBasicMaterial"!=e.material.type&&"VideoMaterial"!=e.material.type||(e.material.envMap=null),e.material.needsUpdate=!0)})}):t.object.traverse(function(e){e.geometry&&e.material&&(e.material.envMap=t.envMap,"MeshBasicMaterial"!=e.material.type&&"VideoMaterial"!=e.material.type||(e.material.envMap=null),e.material.needsUpdate=!0)})}},this.setupMaterial=function(e,t){var n,a,o=this,i=o.sceneData[o.indexSceneCurrent].data,r=o.sceneData[o.indexSceneCurrent].textures,s=o.sceneData[o.indexSceneCurrent].data.materialsLinks,l=[];for(n=0;n<s.length;n++)if(null==!Array.isArray(s[n].mats)){if(s[n].id==t){l[0]=s[n].m;break}}else if(s[n].id==t&&s[n].mats){for(a=0;a<s[n].mats.length;a++)l[a]=s[n].mats[a].m;break}var d,c=[],u=!1,m=new THREE.MeshPhongMaterial({color:16777215,specular:1118481,shininess:0,skinning:u});if("SkinnedMesh"==e.type&&(u=!0),0==l.length)return addToLog("- - -  no mat - - - "),void(e.material=m);for(n=0;n<l.length;n++){d=0,n<l.length&&(d=l[n]),d>=i.materials.length&&(d=0);var h=i.materials[d],p=h.type,g=h.shininess,v=h.color,f=h.specular;null==f&&(f=1118481);var y=h.reflectivity,b=h.doubleSide,M=h.colorMap,T=h.normalMap,E=h.metalnessMap,L=h.roughness,x=h.metalness,k=h.chroma;if("MeshPhongMaterial"==p&&is.windowsPhone(arguments)&&(p="MeshBasicMaterial"),"MeshStandardMaterial"==p&&(c[n]=new THREE.MeshStandardMaterial({color:v,skinning:u,roughness:L,metalness:x})),"MeshPhongMaterial"==p&&(c[n]=new THREE.MeshPhongMaterial({color:v,specular:f,reflectivity:y,shininess:g,skinning:u})),"MeshLambertMaterial"==p&&(c[n]=new THREE.MeshLambertMaterial({color:v,skinning:u})),"MeshBasicMaterial"==p&&(c[n]=new THREE.MeshBasicMaterial({color:v,skinning:u})),"MeshToonMaterial"==p&&(c[n]=new THREE.MeshToonMaterial({color:v,specular:f,reflectivity:y,shininess:g,skinning:u})),"VideoMaterial"==p)if(k){var w=r[d].colorMap,_=new THREE.Color(h.chromaColor);c[n]=new THREE.ShaderMaterial({uniforms:{texture:{type:"t",value:w},color:{type:"c",value:_}},vertexShader:"varying mediump vec2 vUv;\nvoid main(void)\n{\nvUv = uv;\nmediump vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\ngl_Position = projectionMatrix * mvPosition;\n}",fragmentShader:"uniform mediump sampler2D texture;\nuniform mediump vec3 color;\nvarying mediump vec2 vUv;\nvoid main(void)\n{\n  mediump vec3 tColor = texture2D( texture, vUv ).rgb;\n  mediump float a = (length(tColor - color) - 0.5) * 7.0;\n  gl_FragColor = vec4(tColor, a);\n}",transparent:!0})}else c[n]=new THREE.MeshBasicMaterial({color:v,skinning:u});if(null==c[n]&&(console.log("ERROR: m[i] is undefined > DEFAULT MAT"),console.log(p),c[n]=m),M&&M.url&&""!=M.url)"mp4"!=M.url.substr(M.url.lastIndexOf(".")+1)&&1==M.useAlpha&&(c[n].transparent=!0),c[n].map=r[d].colorMap;T&&"MeshBasicMaterial"!=p&&T.url&&""!=T.url&&(c[n].normalMap=r[d].normalMap),"MeshStandardMaterial"==p&&E&&""!=E.url&&null!=E.url&&(c[n].metalnessMap=r[d].metalnessMap,c[n].roughnessMap=r[d].metalnessMap),c[n].side=1==b?THREE.DoubleSide:THREE.FrontSide}var R=!1;e.geometry.groups&&0<e.geometry.groups.length&&(R=!0),R&&1<l.length?e.material=c:e.material=c[0]},this.setupAnimations=function(){var e=this,t=e.sceneData[e.indexSceneCurrent].animations,n=e.sceneData[e.indexSceneCurrent].object;t&&e.sceneData[e.indexSceneCurrent].data.settings.animations&&(e.mixer=new THREE.AnimationMixer(n))},this.playAnimation=function(e){if(-1!=e){var t=this;t.mixer||(t.mixer=new THREE.AnimationMixer(t.object)),t.mixer.stopAllAction();var n=t.sceneData[t.indexSceneCurrent].animations,a=t.mixer.clipAction(n[e]);t.sceneData[t.indexSceneCurrent].data.settings;t.mixer.addEventListener("loop",onLoopAction),a.play()}},this.setupAudio=function(){var t=this;if((addToLog("setup audio"),t.data.settings.audio)&&(t.data.settings.audio.sounds&&-1!=t.data.settings.audio.activeIndex)){var e=t.projectFolder+t.data.settings.audio.sounds[0].url,n=new THREE.AudioListener;_arScene.camera.add(n),t.sound=new THREE.Audio(n),(new THREE.AudioLoader).load(e,function(e){addToLog("audio loaded"),t.sound.setBuffer(e),"none"==document.getElementById("playPanel").style.display&&(_body.classList.contains("m")||1==t.data.settings.audio.noMarker)&&t.playAudio()})}},this.playAudio=function(){addToLog("-> playaudio is there is one");var e=this;if(e.sound)try{e.sound.isPlaying&&(e.data.settings.audio.noMarker||e.sound.stop()),e.sound.play()}catch(e){}},this.pauseAllVideoTextures=function(){addToLog("--> pause all video textures");var e,t=document.querySelectorAll(".videoTexture");if(t)for(e=0;e<t.length;e++)t[e].pause()},this.streamResized=function(){_streamW!=_video.videoWidth&&(addToMainLog("> > streamResized "+_video.videoWidth+" x "+_video.videoHeight),_streamW=_video.videoWidth,_streamH=_video.videoHeight,_video.width=_streamW,_video.height=_streamH,this.resizeCanvas())},this.resizeCanvas=function(){if(is.ios(_arguments)&&null!=_video&&_video.play(),null!=_arScene){var e=window.innerWidth,t=window.innerHeight,n=e/t,a=640/480,o="landscape";_streamW<_streamH&&(o="portrait"),"portrait"===o?(_body.classList.add("p"),a=.75,_arScene.scene.background.rotation=-1*Math.PI/2):(_body.classList.remove("p"),_arScene.scene.background.rotation=0);var i=e,r=i/a;n<a&&(i=(r=t)*a),i=parseInt(i),r=parseInt(r);var s=!1;if(is.ios(_arguments)?"portrait"==o&&n<1&&(s=!0):"portrait"==o&&(s=!0),s){var l=i;i=r,r=l}this.renderer.setSize(parseInt(i/1),parseInt(r/1),!1),_canvas.style.width=i+"px",_canvas.style.height=r+"px"}},this.ARThreeOnLoad=function(){var n=this;addToMainLog("ARThreeOnLoad");var e=_rootDirectory+"assets/data/camera_para-iPhone 5 rear 640x480 1.0m.dat";_video=ARController.getUserMediaThreeScene({maxARVideoSize:320,cameraParam:e,onSuccess:function(e,t){addToMainLog("GOT stream"),n.arController=t,_arScene=e,_body.classList.add(n.arController.orientation),is.ios(arguments)&&window.addEventListener("focus",function(){setTimeout(function(){_video&&_video.play()},1e3)}),n.loadMarker()}}),delete window.ARThreeOnLoad},this.loadMarker=function(){var t=this,e="assets/data/xrplus-marker16.pat",n=.5;0<t.indexSceneLoading&&(n=.55);var a,o=t.sceneData[t.indexSceneLoading].data;if(o.pattern.id&&(e="p/"+o.pattern.folder+"/"+o.pattern.id+"/"+o.pattern.id+".pat",n=.6,"btf"==o.pattern.id&&(n=.5)),t.arController.setPattRatio(n),!t.multipleTracking&&1<t.sceneData.length)for(a=0;a<t.indexSceneLoading;a++)if(t.sceneData[a].data.pattern.id==o.pattern.id)return addToLog("skip loading marker "+t.indexSceneLoading),t.sceneData[t.indexSceneLoading].markerRoot=null,void t.allSceneDataLoaded();t.arController.loadMarker(_rootDirectory+e,function(e){t.sceneData[t.indexSceneLoading].markerRoot=t.arController.createThreeMarker(e),t.allSceneDataLoaded()})}}function onLoopAction(){var e=_xr,t=e.sceneData[e.indexSceneCurrent].data.url;console.log(e.sceneData[e.indexSceneCurrent]);var n={message:"onLoopAnimation",scene:t};parent.postMessage(n,"*")}function onFinishedAction(){_xr.mixer.removeEventListener("finished",onFinishedAction)}function tools(e){this.c=e,this.toolsDom=null,this.toolsButtonsWrapper=null,this.photoModuleDom=null,this.animationsModuleDom=null,this.materialsModuleDom=null,this.eggModuleDom=null,this.photoData=null,this.setupTools=function(){addToMainLog("X setupTools");var e=this,t=e.c.data.settings.tools;null==t&&alert("tools undefined");var n=document.createElement("div");n.id="loadingTools",n.innerHTML="<p>please wait...</p>",document.body.appendChild(n),e.toolsDom=document.createElement("div"),e.toolsDom.id="tools",document.body.appendChild(e.toolsDom),e.toolsButtonsWrapper=document.createElement("div"),e.toolsButtonsWrapper.id="toolsButtonsWrapper",e.toolsDom.appendChild(e.toolsButtonsWrapper),1==t.photo.enabled&&e.photoModule(),1==t.animations.enabled&&e.animationsModule(),1==t.materials.enabled&&e.materialsModule(),t.egg&&1==t.egg.enabled&&(e.eggModule(),e.closeModules(),e.eggModuleDom.style.display="block",document.body.classList.add("eggModule")),document.onkeyup=function(e){if(13==e.which)return document.activeElement.blur(),!1}},this.closeModules=function(){var e=this;e.animationsModuleDom&&(e.animationsModuleDom.style.display="none"),e.materialsModuleDom&&(e.materialsModuleDom.style.display="none"),e.eggModuleDom&&(e.eggModuleDom.style.display="none"),e.photoModuleDom&&(e.photoModuleDom.style.display="none"),document.body.classList.remove("eggModule")},this.animationsModule=function(){var e=this;if(e.c.animations&&1!=_xr.multipleTracking){var t=document.createElement("span");t.setAttribute("class","button"),t.innerHTML="animations",e.toolsButtonsWrapper.appendChild(t),e.animationsModuleDom=document.createElement("div"),e.animationsModuleDom.id="animationsModule",document.body.appendChild(e.animationsModuleDom);var n=document.createElement("span");n.setAttribute("class","b_close"),e.animationsModuleDom.appendChild(n);var a=document.createElement("h3");a.innerHTML="animations",e.animationsModuleDom.appendChild(a);var o,i,r=document.createElement("div");r.setAttribute("class","buttons"),e.animationsModuleDom.appendChild(r);var s=e.c;if(s.animations)for(o=0;o<s.animations.length;o++)(i=document.createElement("span")).setAttribute("class","button"),i.setAttribute("data-index",o),i.innerHTML=excerpt(s.animations[o].name,13),r.appendChild(i),i.addEventListener(_clickOrTouch,function(){r.querySelectorAll(".button").forEach(function(e){e.classList.remove("active")}),this.classList.add("active");var e=this.getAttribute("data-index");_xr.playAnimation(e)});t.addEventListener("click",function(){"block"!=e.animationsModuleDom.style.display?(e.closeModules(),e.animationsModuleDom.style.display="block"):e.closeModules()}),n.addEventListener(_clickOrTouch,function(){e.closeModules()})}},this.materialsModule=function(){var n=this;if(1!=_xr.multipleTracking){if(null==window.jscolor){var e=document.createElement("script");return e.onload=function(){n.materialsModule()},e.src=_rootDirectory+"js/tools/jscolor.min.js",void document.head.appendChild(e)}var t=n.c.data.settings.tools.materials,a=document.createElement("span");a.setAttribute("class","button"),a.innerHTML="colors",n.toolsButtonsWrapper.appendChild(a),n.materialsModuleDom=document.createElement("div"),n.materialsModuleDom.id="materialsModule",document.body.appendChild(n.materialsModuleDom);var o=document.createElement("span");o.setAttribute("class","b_close"),n.materialsModuleDom.appendChild(o);var i=document.createElement("h3");i.innerHTML="colors",n.materialsModuleDom.appendChild(i);var r,s,l,d,c,u,m,h=document.createElement("div");for(h.setAttribute("class","buttons"),n.materialsModuleDom.appendChild(h),r=d=0;r<n.c.data.materials.length;r++){for(m=n.c.data.materials[r].name,s=0;s<t.mats.length;s++)t.mats[s].name==m&&1==t.mats[s].enabled&&(u=n.c.data.materials[r].color.replace("#",""),l=document.createElement("span"),h.appendChild(l),l.setAttribute("class","button"),l.setAttribute("data-index",d),l.innerHTML=excerpt(m,13),l.style.background="#"+u,(c=document.createElement("input")).setAttribute("class","jscolor"),c.setAttribute("readonly","readonly"),c.setAttribute("data-index",r),c.setAttribute("value",u),l.appendChild(c),c.addEventListener(_clickOrTouch,function(){document.activeElement.blur()}),c.addEventListener("change",function(){var e=this.getAttribute("data-index"),t=this.value;n.c.data.materials[e].color="#"+t,this.parentElement.style.background="#"+t,_xr.setupMaterials()}));d++}window.jscolor.installByClassName("jscolor"),a.addEventListener("click",function(){"block"!=n.materialsModuleDom.style.display?(n.closeModules(),n.materialsModuleDom.style.display="block"):n.closeModules()}),o.addEventListener(_clickOrTouch,function(){n.closeModules()})}},this.photoModule=function(){var e=this,t=document.createElement("span");t.id="b_takePhoto",t.setAttribute("class","button"),t.innerHTML='<img src="'+_rootDirectory+'assets/icon-camera.svg" alt="">',e.toolsDom.appendChild(t),e.photoModuleDom=document.createElement("div"),e.photoModuleDom.id="photoModule",document.body.appendChild(e.photoModuleDom);var n=document.createElement("span");n.setAttribute("class","b_close"),e.photoModuleDom.appendChild(n);var a=document.createElement("div");a.id="photoPreviewWrapper",e.photoModuleDom.appendChild(a);var o=document.createElement("img");o.id="photoPreview",o.setAttribute("class","preview"),a.appendChild(o);var i=document.createElement("div");i.id="photoForm",this.photoModuleDom.appendChild(i);var r=document.createElement("div");r.setAttribute("class","fields"),i.appendChild(r);var s=document.createElement("p"),l="Share the photo by email";_texts.shareThePhotoByEmail&&(l=_texts.shareThePhotoByEmail),s.innerHTML=l,r.appendChild(s);var d=document.createElement("input");d.id="photoEmail",d.setAttribute("placeholder","email"),d.setAttribute("type","email"),d.setAttribute("autocorrect","off"),d.setAttribute("autocapitalize","off"),r.appendChild(d);var c=document.createElement("span");c.id="b_sendPhoto",c.setAttribute("class","button"),c.innerHTML="send",r.appendChild(c),n.addEventListener("click",function(){e.closeModules()}),t.addEventListener(_clickOrTouch,function(){e.takePhoto()}),c.addEventListener(_clickOrTouch,function(){e.sendPhoto()})},this.eggModule=function(){function l(){var e,t,n;for(e=0;e<d*d;e++)n=16*parseInt(e/d),t=e%d*16,g.fillStyle=m[e].getAttribute("data-color"),g.fillRect(t,n,16,16);var a=g.getImageData(0,0,64,64);g.putImageData(a,0,0);var o=new THREE.Texture(p);o.wrapS=o.wrapT=THREE.RepeatWrapping,o.repeat.set(8,8),h.material.map=o,h.material.needsUpdate=!0,h.material.map.needsUpdate=!0}var e=this,t=document.createElement("span");t.setAttribute("class","button"),t.innerHTML="egg painter",e.toolsButtonsWrapper.appendChild(t),e.eggModuleDom=document.createElement("div"),e.eggModuleDom.id="eggModule",document.body.appendChild(e.eggModuleDom);var n,a=document.createElement("span");a.setAttribute("class","b_close"),e.eggModuleDom.appendChild(a);var o,i,d=4,r=document.createElement("div");for(r.id="palette",e.eggModuleDom.appendChild(r),n=0;n<8;n++){switch((o=document.createElement("div")).setAttribute("class","cell"),n){case 0:i="#ffb000";break;case 1:i="#59b1ff";break;case 2:i="#FF33CC";break;case 3:i="#80ff33";break;case 4:i="#ff0000";break;case 5:i="#ffffff";break;case 6:i="#909090";break;case 7:i="#202020"}o.setAttribute("data-color",i),o.style.background=i,r.appendChild(o)}var s=document.querySelectorAll("#palette .cell"),c=s[0].getAttribute("data-color");for(s[0].classList.add("active"),n=0;n<s.length;n++)s[n].addEventListener(_clickOrTouch,function(){var e;for(c=this.getAttribute("data-color"),e=0;e<s.length;e++)s[e].classList.remove("active");this.classList.add("active")});var u=document.createElement("div");for(u.id="patternGrid",e.eggModuleDom.appendChild(u),n=0;n<d*d;n++)(o=document.createElement("div")).setAttribute("class","cell"),o.setAttribute("data-color","#FFFFFF"),o.setAttribute("data-index",n),o.style.background="#FFFFFF",u.appendChild(o);var m=document.querySelectorAll("#patternGrid .cell");for(n=0;n<m.length;n++)m[n].addEventListener(_clickOrTouch,function(){c!=this.getAttribute("data-color")&&(this.style.background=c,this.setAttribute("data-color",c),l())});u.addEventListener("touchmove",function(e){var t=u.getBoundingClientRect().width/d,n=u.getBoundingClientRect().left,a=e.touches[0].pageX-n,o=window.innerHeight-e.touches[0].pageY-n,i=parseInt(a/t),r=d-1-parseInt(o/t),s=m[r*d+i];c!=s.getAttribute("data-color")&&(s.style.background=c,s.setAttribute("data-color",c),l())});var h=e.c.object.children[0],p=document.createElement("canvas");p.width=64,p.height=64;var g=p.getContext("2d");g.imageSmoothingEnabled=!1,g.webkitImageSmoothingEnabled=!1,t.addEventListener("click",function(){"block"!=e.eggModuleDom.style.display?(e.closeModules(),e.eggModuleDom.style.display="block",document.body.classList.add("eggModule")):e.closeModules()}),a.addEventListener(_clickOrTouch,function(){e.closeModules()});var v=document.createElement("span");v.id="b_takePhotoEgg",v.setAttribute("class","button"),v.innerHTML='<img src="'+_rootDirectory+'assets/icon-camera.svg" alt="">',e.eggModuleDom.appendChild(v),v.addEventListener(_clickOrTouch,function(){e.takePhoto()})},this.startLoading=function(){$("#loadingTools").css("display:block")},this.stopLoading=function(){$("#loadingTools").css("display:none")},this.takePhoto=function(){var i=this;$("#b_takePhoto").css("display:none"),i.closeModules(),setTimeout(function(){var o=document.getElementById("threejs");i.photoData=new FormData,function(){if(document.body.classList.contains("p")){var t=new Image;t.src=o.toDataURL();var n=document.createElement("canvas");n.width=o.height,n.height=o.width;var a=n.getContext("2d");t.onload=function(){a.translate(0,t.width),a.rotate(-90*Math.PI/180),a.drawImage(t,0,0);var e=n.toDataURL("image/jpeg",.8);n=null,document.getElementById("photoPreview").src=e,i.photoData.append("imgBase64",e),i.photoData.append("url",_projectURL),i.photoModuleDom.style.display="block"}}else{var e=o.toDataURL("image/jpeg",.8);document.getElementById("photoPreview").src=e,i.photoData.append("imgBase64",e),i.photoData.append("url",_projectURL),i.photoModuleDom.style.display="block"}}(),setTimeout(function(){$("#b_takePhoto").css("display:inline-block")},600),document.activeElement.blur()},50)},this.savePhoto=function(){var e="xr-dot-plus-"+_projectURL+".jpg",t=document.getElementById("photoPreview").src;is.safari(_arguments)||(t=t.replace(/^data:image\/[^;]/,"data:application/octet-stream"));var n=document.createElement("a");n.setAttribute("href",t),n.setAttribute("download",e),document.body.appendChild(n),n.click()},this.sendPhoto=function(){var n=this;document.activeElement.blur();var e=document.getElementById("photoEmail").value;if(validateEmail(e)){$("#photoModule").attr("class",""),n.startLoading();var t=_rootDirectory+"d/take-photo.php",a=n.photoData;a.append("email",e);var o=new XMLHttpRequest;o.open("POST",t,!0),o.onload=function(){if(200<=o.status&&o.status<400){n.stopLoading();var e="Your photo has been sent";_texts.yourPhotoHasBeenSent&&(e=_texts.yourPhotoHasBeenSent);var t=JSON.parse(o.response);t.error&&(e="error : "+t.error),openModal(e)}else console.log("error a"),n.stopLoading(),openModal("error a")},o.onerror=function(){console.log("error b"),n.stopLoading(),openModal("error b")},o.send(a)}else openModal("Please enter a valid email")},this.setupTools()}function checksAR(){this.ok=1,this.arguments=null,this.urlAR=window.location.href,this.urlVR="",this.start=function(){if(this.arguments=this.getArguments(),"#"===this.urlAR.substr(-1)&&(this.urlAR=this.urlAR.substr(0,this.urlAR.length-1)),this.urlVR=this.urlAR.replace("xr.plus/","xr.plus/vr/"),is.ios(this.arguments)){var e=iOSversion(),t=0;if(null!=e&&(t=e[0]),t<11){var n="Unfortunately, <br/>augmented reality on the web requires iOS 11.<br/>";return n+='<a href="'+this.urlVR+'" class="button">View the scene in 360&#186;</a>',n+="<br/>",void this.showFail(n)}if(!is.safari(this.arguments)){n="<br/>Please open this page in Safari<br/>&nbsp;";this.showFail(n);var a=document.createElement("span");return a.id="helpOpenSafari",a.innerHTML="Tap here and choose<br/>'open in browser'",void document.getElementById("fail").appendChild(a)}}if(void 0===navigator.getUserMedia&&void 0===navigator.mediaDevices&&(this.ok=0),void 0!==navigator.mediaDevices&&(void 0===navigator.mediaDevices.enumerateDevices&&(this.ok=0),void 0===navigator.mediaDevices.getUserMedia&&(this.ok=0)),addToLog("chrome "+is.chrome(this.arguments)),addToLog("safari "+is.safari(this.arguments)),!is.ios(this.arguments)&&!is.android(this.arguments)&&!this.ok){n="Unfortunately, <br/>This browser cannot display<br/>Augmented Reality content.<br/><br/>";n+='<a href="'+this.urlVR+'" class="button">View the scene in 360&#186;</a>',this.showFail(n)}if(is.ios(this.arguments)&&!this.ok){n="<br/>"+this.urlAR+"<br/><br/><br/>";n+="Unfortunately, <br/>This browser cannot display<br/>Augmented Reality content.<br/><br/>",n+="Please open this page in Safari",this.showFail(n)}if(is.android(this.arguments)&&is.not.windowsPhone(this.arguments)&&(is.not.chrome(this.arguments)&&is.not.firefox(this.arguments)&&(this.ok=0),!this.ok)){n='Unfortunately, <br/>This browser cannot display<br/>Augmented Reality content.<br/><br/>If you have Chrome installed, <br/><a href="#" id="chromeButton">tap here</a> <br/>to visit this page in Chrome.<br/><br/>';this.showFail(n),document.getElementById("chromeButton").onclick=function(){var e=window.location.href;"#"===e.substr(-1)&&(e=e.substr(0,e.length-1)),e="googlechrome://navigate?url="+e,document.location=e}}},this.showFail=function(e){var t=document.createElement("div");t.id="fail",document.body.appendChild(t);var n=document.createElement("div");n.id="message",n.innerHTML=e,t.appendChild(n)},this.getArguments=function(){return arguments},this.start()}function iOSversion(){if(/iP(hone|od|ad)/.test(navigator.platform)){var e=navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/);return[parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3]||0,10)]}}function doChecks(){var e=new checksAR;if(is.desktop(_arguments)&&(document.getElementById("youtubeIframeWrapper").innerHTML='<iframe width="711" height="400" src="https://www.youtube.com/embed/D6Z0U6319EQ?rel=0" frameborder="0" gesture="media" allow="encrypted-media" allowfullscreen></iframe>'),1==e.ok)if(!is.desktop(_arguments)||_skipDesktopAR||_isDebug||"https://xr.plus/"!=_rootDirectory)loadSceneData();else{var t=document.getElementById("preloader");t&&t.parentElement.removeChild(t),$("#desktop").css("backgroundImage: url('"+_rootDirectory+"assets/bg-ar-desktop.jpg');display:block"),$("#b_continueOnDesktop").on(_clickOrTouch,function(){navigator.getMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getMedia({video:!0},function(){$("#desktop").css("display:none;"),loadSceneData()},function(){$("#desktop").css("display:none;"),$("#noAccess").css("display:block;"),$("#noCamera").css("display:block;"),$("#yesCamera").css("display:none;")})}),$("#logo").on(_clickOrTouch,function(){document.getElementById("desktop")&&"block"==document.getElementById("desktop").style.display&&(top.location=_rootDirectory)})}}function loadSceneData(){var e=document.getElementById("desktop");e.parentElement.removeChild(e);var t=encodeURIComponent(document.referrer),n=_rootDirectory+"d/get-scene-front-dev2.php?url="+_projectURL+"&r="+t+"&ar";_isDebug&&(n+="&d");var a=new XMLHttpRequest;a.open("GET",n,!0),a.onload=function(){if(200<=a.status&&a.status<400){var e=JSON.parse(a.responseText);if(e.error)return void alert("error : "+e.error);dataSceneLoaded(e)}else console.log("error a")},a.onerror=function(){console.log("error b")},a.send()}function dataSceneLoaded(e){var t=e.scenesData;1<t.length&&$("body").addClass("collection");var n=!1;if(e.settings.multiScene&&e.settings.multiScene.multiMarkers&&1==e.settings.multiScene.multiMarkers&&(n=!0),!n&&1<t.length){var a=document.createElement("div");a.id="sceneSelector",$("body").addClass("sceneSelector"),document.querySelector("footer").appendChild(a);var o,i,r,s=document.createElement("ul");for(a.appendChild(s),o=0;o<t.length;o++)r=_rootDirectory+"s/"+t[o].folder+"/"+t[o].url+"/"+t[o].preview,(i=document.createElement("li")).setAttribute("data-index",o),i.style.visibility="hidden",i.innerHTML='<img class="preview" src="'+r+'" alt=""/>',s.appendChild(i),i.addEventListener(_clickOrTouch,function(){var e=this.getAttribute("data-index");_xr.selectScene(e),$("#sceneSelector li").attr("class",""),this.className="active"});$("#sceneSelector li").eq(0).attr("class","active")}startAR(0,e)}function startAR(e,t){addToLog("D: startAR "+e+" / "+t.scenesData.length),_isDebug&&console.log(t.scenesData),(_xr=new ar(t)).setNewData(e),_xr.initScene(e),setOrientation(),$("#logo").on(_clickOrTouch,function(){clickOnlogo(t.scenesData[0])})}function clickOnlogo(e){var t=e.settings.redirection,n=e.settings.logoMenu;if(n){var a=n.moreButtons;if(a&&0<a.length){var o,i=0;for($("#redirection").css("display:block;"),$("#redirection>div").html(""),i=0;i<a.length;i++)""!=a[i].url&&null!=a[i].url&&(""==a[i].textParagraph&&(a[i].textParagraph="&nbsp;"),o="",o+="<p>"+a[i].textParagraph+"</p>",o+='<p><a class="button" href="'+a[i].url+'" target="_top">'+a[i].textButton+"</a></p>",$("#redirection>div").insertLast(o))}}else{if((t=e.settings.redirection)&&t.url&&11<t.url.length)return $("#redirection").css("display:block;"),$("#p_redirection").text(t.textParagraph),void $("#b_redirection").attr("href",t.url).text(t.textButton)}"block"!=document.getElementById("more").style.display?$("#more").css("display:block;"):$("#more").css("display:none;")}function setOrientation(){_isVertical?($("#h").removeClass("active"),$("#v").addClass("active")):($("#h").addClass("active"),$("#v").removeClass("active")),_xr.setOrientation()}function openModal(e){var t=document.createElement("div");t.id="bgModal",t.innerHTML='<div id="alertModal"><p>'+e+'</p><div class="buttons"><span class="button ok">ok</span></div></div></div>',document.body.appendChild(t),document.querySelector("#alertModal .button.ok").addEventListener(_clickOrTouch,function(){var e=document.getElementById("bgModal");e&&e.parentElement.removeChild(e)})}var k,_texts={};for(k in"fr"!=_language&&"fr-FR"!=_language||(_texts={betterOnMobile:"La réalité augmentée, c'est mieux sur téléphone",visitOnMobile:"Avec le navigateur internet de votre téléphone, visitez ",continueAnyway:"Continuer sur cet écran",print:"Imprimer le motif R.A.",allowAccess:"Veuillez autoriser l'accès à la caméra",noAccess:"pas d'accès à la caméra",yesCamera:"L'accès à votre caméra est necéssaire",noCamera:"Il semble que votre appareil n'a pas de caméra connectée",tryAgain:"réessayer",displayThePattern:"afficher le motif R.A.",loadingTheMagic:"Chargement",direct:"Pointez la caméra vers ce motif",directMultiple:"Pointez la caméra vers ces motifs",iDontHave:"Je ne l'ai pas",onAnother:"Avec un autre téléphone ou un ordinateur, visitez "+_domainMin+"/p pour afficher le motif R.A.",visitThisLink:"Visitez ce lien avec le navigateur internet de votre téléphone \net dirigez la caméra ici.",visitThisLinkPattern:"Visitez ce lien avec le navigateur internet de votre téléphone \net dirigez la caméra sur ce motif.",flat:"à plat",vertical:"vertical",discoverMoreOnTheHome:"Découvrez d'autres scènes sur la page d'accueil",discoverMore:"Découvrir d'autres scènes",joinTheCommunityTop:"Rejoignez la communauté et publiez vos modèles 3D",joinTheCommunity:"Rejoignez la communauté et publiez vos modèles 3D",joinNow:"Rejoindre la communauté",help:"aide",shareThePhotoByEmail:"Envoyer la photo via email",yourPhotoHasBeenSent:"La photo a été envoyée"}),"pl"!=_language&&"pl-PL"!=_language||(_texts={betterOnMobile:"Rozszerzona rzeczwistość jest lepsza na urządzeniach mobilnych",visitOnMobile:"Odwiedź na swoim telefonie: ",continueAnyway:"kontynuuj mimo to",print:"Wydrukuj wzór AR",allowAccess:"Zezwól na dostęp do kamery",noAccess:"Brak dostępu do kamery",yesCamera:"Dostęp do kamery urządzenia jest niezbędny, jeśli chcesz doświadczyć rozszerzonej rzeczywistości",noCamera:"Przepraszamy, nie wykryto kamery. Podłącz kamerę i spróbuj ponownie.",tryAgain:"spróbuj ponownie",displayThePattern:"wyświetl wzór AR",loadingTheMagic:"Ładowanie",direct:"Skieruj kamerę na ten wzór",directMultiple:"Skieruj kamerę na ten wzór",iDontHave:"Nie mam go",onAnother:"Żeby wyświetlić wzór AR, odwiedź "+_domainMin+"/p na innym telefonie lub komputerze",visitThisLink:"Otwórz link w przeglądarce na telefonie \ni skieruj kamerę tutaj.",visitThisLinkPattern:"Otwórz link w przeglądarce na telefonie \ni skieruj kamerę na ten wzór.",flat:"płaski",vertical:"pionowy",discoverMoreOnTheHome:"Odkryj więcej na stronie głównej",discoverMore:"Odkryj więcej",joinTheCommunityTop:"Dołącz do społeczności i dodaj swoje modele 3D!",joinTheCommunity:"Dołącz do społeczności i dodaj swoje modele",joinNow:"Dołącz teraz",help:"pomoc"}),_texts)setText(k,_texts[k]);var QueryString=function(){for(var e={},t=window.location.search.substring(1).split("&"),n=0;n<t.length;n++){var a=t[n].split("=");if(void 0===e[a[0]])e[a[0]]=decodeURIComponent(a[1]);else if("string"==typeof e[a[0]]){var o=[e[a[0]],decodeURIComponent(a[1])];e[a[0]]=o}else e[a[0]].push(decodeURIComponent(a[1]))}return e}(),_sw=1e3,_sh=500,_clickOrTouch="ontouchend"in window?"touchend":"click",nano=function(e){return this.value=Array.prototype.slice.call(document.querySelectorAll(e)),this};nano.prototype={eq:function(e){return this.value=[this.value[e]],this},each:function(e){return[].forEach.call(this.value,e),this},css:function(t){return this.each(function(e){e.style.cssText=e.style.cssText+t})},cssdom:function(n){return this.each(function(e){for(var t in n)e.style[t]=n[t]})},attr:function(t,n){return this.each(function(e){e.setAttribute(t,n)})},getAttr:function(e){return this.value[0].getAttribute(e)},removeAttr:function(t){return this.each(function(e){e.removeAttribute(t)})},animate:function(t,n,a,o,i,r,s,l,d,c){return this.each(function(e){e.style.cssText=e.style.cssText+"transition: all "+t+"s ease-in-out; transform: scale("+n+") rotate("+a+"deg) rotateX("+o+"deg) rotateY("+i+"deg) translate("+r+"px, "+s+"px) skew("+l+"deg, "+d+"deg); opacity:"+c+";)"})},on:function(t,n){return this.each(function(e){e.addEventListener(t,n,!1)})},addClass:function(t){return this.each(function(e){e.classList?e.classList.add(t):e.className+=" "+t})},toggleClass:function(t){return this.each(function(e){e.classList.toggle(t)})},removeClass:function(t){return this.each(function(e){e.classList.remove(t)})},html:function(t){return this.each(function(e){e.innerHTML=t})},text:function(t){return this.each(function(e){e.innerText=t})},insertBefore:function(t){return this.each(function(e){e.insertAdjacentHTML("beforeBegin",t)})},insertAfter:function(t){return this.each(function(e){e.insertAdjacentHTML("afterEnd",t)})},insertFirst:function(t){return this.each(function(e){e.insertAdjacentHTML("afterBegin",t)})},insertLast:function(t){return this.each(function(e){e.insertAdjacentHTML("beforeEnd",t)})},empty:function(){return this.each(function(e){e.innerHTML=""})},offset:function(){return this.each(function(e){offset=e.getBoundingClientRect()})}};var $=function(e){return new nano(e)};!function(){var e=function(){window.ARController&&window.THREE?(ARController.getUserMediaThreeScene=function(e){var t={};for(var n in e)t[n]=e[n];var a=e.onSuccess;return t.onSuccess=function(e,t){var n=e.createThreeScene();a(n,e,t)},this.getUserMediaARController(t)},ARController.prototype.createThreeScene=function(n){n=n||this.image,this.setupThree();var e=new THREE.VideoTexture(n);e.minFilter=THREE.LinearFilter,e.magFilter=THREE.LinearFilter,e.format=THREE.RGBFormat;var t=new THREE.Scene,a=new THREE.PerspectiveCamera;a.near=1,a.far=50,a.updateProjectionMatrix(),a.matrixAutoUpdate=!1,a.projectionMatrix.fromArray(this.getCameraMatrix()),t.add(a),e.offset.set(0,0),e.center.set(.5,.5),t.background=e;var o=this;return{scene:t,camera:a,arController:this,video:n,process:function(){for(var e in o.threePatternMarkers)o.threePatternMarkers[e].visible=!1;for(var e in o.threeMultiMarkers){o.threeMultiMarkers[e].visible=!1;for(var t=0;t<o.threeMultiMarkers[e].markers.length;t++)o.threeMultiMarkers[e].markers[t]&&(o.threeMultiMarkers[e].markers[t].visible=!1)}o.process(n)},renderOn:function(e){e.render(this.scene,this.camera)}}},ARController.prototype.createThreeMarker=function(e,t){this.setupThree();var n=new THREE.Object3D;return n.markerTracker=this.trackPatternMarkerId(e,t),n.matrixAutoUpdate=!1,this.threePatternMarkers[e]=n},ARController.prototype.createThreeMultiMarker=function(e){this.setupThree();var t=new THREE.Object3D;return t.matrixAutoUpdate=!1,t.markers=[],this.threeMultiMarkers[e]=t},ARController.prototype.setupThree=function(){this.THREE_JS_ENABLED||(this.THREE_JS_ENABLED=!0,this.addEventListener("getMarker",function(e){var t;e.data.marker,e.data.type===artoolkit.PATTERN_MARKER?t=this.threePatternMarkers[e.data.marker.idPatt]:e.data.type===artoolkit.BARCODE_MARKER&&(t=this.threeBarcodeMarkers[e.data.marker.idMatrix]),t&&(t.matrix.fromArray(e.data.matrixGL_RH),t.visible=!0)}),this.addEventListener("getMultiMarker",function(e){var t=this.threeMultiMarkers[e.data.multiMarkerId];t&&(t.matrix.fromArray(e.data.matrixGL_RH),t.visible=!0)}),this.addEventListener("getMultiMarkerSub",function(e){var t=e.data.multiMarkerId,n=e.data.markerIndex,a=e.data.marker,o=this.threeMultiMarkers[t];if(o&&o.markers&&o.markers[n]){var i=o.markers[n];i.matrix.fromArray(e.data.matrix),i.visible=0<=a.visible}}),this.threePatternMarkers={},this.threeBarcodeMarkers={},this.threeMultiMarkers={})},window.ARThreeOnLoad&&window.ARThreeOnLoad()):setTimeout(e,50)};e()}();var _stream=null;ARController.getUserMedia=function(e){if(null==FS)return addToLog("chrome refresh error"),void(document.getElementById("noAccess").style.display="block");var t=e.facingMode||"environment",n=e.onSuccess,a=e.onError||function(){if(addToLog("access camera denied"),document.getElementById("noAccess").style.display="block",is.android(arguments)){var e=document.getElementById("tryAgain");e.textContent="open in Chrome",e.onclick=function(e){e.preventDefault();var t=window.location.href;"#"===t.substr(-1)&&(t=t.substr(0,t.length-1)),document.location="googlechrome://navigate?url="+t}}var t=document.querySelector("#bgVideo");t&&(t.style.display="none");var n=document.querySelector(".videoTexture");n&&(n.style.display="none")},o=document.getElementById("bgVideo");o.autoplay=!0,o.playsInline=!0;var i=!(o.muted=!0),r=["touchstart","touchend","touchmove","touchcancel","click","mousedown","mouseup","mousemove","keydown","keyup","keypress","scroll"],s=function(){if(i){if(is.windowsPhone(arguments)||is.edge(arguments)){if(!o.paused)return;addToLog("$$$ windowsPhone "),o.play();var e=setInterval(function(){o.videoWidth&&(clearInterval(e),n(o))},500);return}if(is.ios(arguments)){if(!o.paused)return;addToLog("$$$ ios $$$");var t=setInterval(function(){if(o&&o.videoWidth&&0<o.videoWidth){o.play(),clearInterval(t);var e=setInterval(function(){o.videoWidth&&(clearInterval(e),n(o))},500)}},500);return}o.play().then(function(){addToMainLog("$$$ on success play");var e=setInterval(function(){o.videoWidth&&(clearInterval(e),n(o))},500)}).catch(function(e){addToMainLog("on error play "+e),alert(e),a(e),ARController._teardownVideo(o)}),o.paused||r.forEach(function(e){window.removeEventListener(e,s,!0)})}};r.forEach(function(e){window.addEventListener(e,s,!0)});var l={},d={};return e.width&&(d.width=e.width,"object"==typeof e.width?(e.width.max&&(l.maxWidth=e.width.max),e.width.min&&(l.minWidth=e.width.min)):l.maxWidth=e.width),e.height&&(d.height=e.height,"object"==typeof e.height?(e.height.max&&(l.maxHeight=e.height.max),e.height.min&&(l.minHeight=e.height.min)):l.maxHeight=e.height),d.facingMode=t,d.deviceId=e.deviceId,(navigator.mediaDevices||window.MediaStreamTrack.getSources)&&navigator.mediaDevices&&(is.android(arguments)&&(addToLog("$$ android constraints"),d={facingMode:{exact:"environment"}}),is.desktop(_arguments)&&(d=!0),navigator.mediaDevices.getUserMedia({audio:!1,video:d}).then(function(e){addToLog("$$$ success"),o.srcObject=e,i=!0,s()},a)),o},ARController.prototype._copyImageToHeap=function(e){e||(e=this.image),this.ctx.save(),e.width<e.height?(this.ctx.translate(this.canvas.width,0),this.ctx.rotate(Math.PI/2),this.ctx.drawImage(e,0,0,this.canvas.height,this.canvas.width)):this.ctx.drawImage(e,0,0,this.canvas.width,this.canvas.height),this.ctx.restore();var t=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height).data;if(this.videoLuma)for(var n=0,a=0;a<this.videoSize;a++){var o=t[n+0],i=t[n+1],r=t[n+2];this.videoLuma[a]=o+o+o+r+i+i+i+i>>3,n+=4}return!!this.dataHeap&&(this.dataHeap.set(t),!0)};var _arScene,_streamW=0,_streamH=0,_canvas=document.getElementById("threejs"),_video=null,_body=document.body;_body.addEventListener("gesturechange",gestureChange,!1),_body.addEventListener("touchmove",gestureChange,!1);var _tools=null,getArguments=function(){return arguments},_arguments=getArguments();is.desktop(_arguments)&&(_clickOrTouch="click");var _xr=null;"undefined"!=typeof _isDebug||(_isDebug=!1),$("#b_marker").on(_clickOrTouch,function(){$("#help").css("display:block;")}),$("#b_close_help").on("click",function(){$("#more").css("display:none;"),$("#help").css("display:none;")}),$("#b_close_patternLarge").on("click",function(){$("#patternLarge").css("display:none;")}),$("#b_close_more").on("click",function(){$("#more").css("display:none;"),$("#help").css("display:none;")}),$("#b_close_redirection").on("click",function(){$("#more").css("display:none;"),$("#help").css("display:none;"),$("#redirection").css("display:none;")}),$("#b_showPattern").on(_clickOrTouch,function(){$("#patternNoCamera").css("display:block;z-index:1000;")}),$("#b_close_patternNoCamera").on(_clickOrTouch,function(){$("#patternNoCamera").css("display:none;")}),$("#h").on(_clickOrTouch,function(){_isVertical=!1,setOrientation()}),$("#v").on(_clickOrTouch,function(){_isVertical=!0,setOrientation()}),document.getElementById("mainLog")&&$("#mainLog").on(_clickOrTouch,function(){$("#mainLog").css("display:none;"),$("#bgVideo").css("opacity:0;")}),doChecks();