function addToMainLog(e){addToLog(e)}function addToLog(e){$("#mainLog")&&$("#mainLog").insertFirst("<p>"+e+"</p>")}function vr(e){this.mouse=new THREE.Vector2,this.isVRReady=!0,this.data=null,this.currentMode="vr",this.projectFolder=null,this.scene=null,this.camera=null,this.renderer=null,this.rootXR=null,this.rootModel=null,this.mixer=null,this.animations=[],this.activeAnimationIndex=-1,this.controls=null,this.clock=null,this.viewfinder=null,this.textures=[],this.nbTextureFiles=0,this.currentTextureFileIndex=0,this.tris=0,this.texturesTotalFileSize=0,this.rootLighting=null,this.ambientLight=null,this.light=[],this.skyBox=null,this.footerHeight=80,this.displayName="",this.needAudioButton=!1,this.controlsLock=null,this.addToLog=function(e){addToLog(e)},this.checkAvailability=function(){var o=this;o.camera.position.set(0,0,2),o.rootXR.position.set(0,-1,0),o.controls||(o.addToLog("+ add orbit controls"),o.controls=new THREE.OrbitControls(o.camera,o.renderer.domElement),o.controls.maxDistance=10,o.data.settings.controls&&1==o.data.settings.controls.limitMaxPolarAngle&&(o.controls.maxPolarAngle=Math.PI/2)),addToLog("check VR Availability"),"getVRDisplays"in navigator?(addToLog("VR Browser"),window.addEventListener("vrdisplayconnect",function(e){addToLog("vrdisplayconnect"),o.setupVRDisplay(e.display)},!1),window.addEventListener("vrdisplaydisconnect",function(){addToLog("vrdisplaydisconnect"),o.disableVR(!0,!1)},!1),window.addEventListener("vrdisplaypresentchange",function(e){if(addToLog("toggle VR "+e.display.isPresenting),e.display.isPresenting?$("body").addClass("vr"):$("body").removeClass("vr"),e.display.isPresenting){addToLog("set rootXR pos "+jsonToString(o.rootXR.position)),is.android(arguments)?o.rootXR.position.set(0,.3,0):-1!==o.displayName.indexOf("oculus")?(o.rootXR.position.set(0,1,-2),addToLog("--- OCULUS POSITION")):o.rootXR.position.set(0,-1,-2),o.rootXR.position.set(0,0,-1),o.camera.position.set(0,0,0);var t=document.querySelector(".videoTexture");t&&(t.volume=1,t.play(),addToLog("PLAY VIDEO "))}else o.addToLog("revert positions+"),o.camera.position.set(0,0,2),o.rootXR.position.set(0,-1,0)},!1),navigator.getVRDisplays().then(function(e){console.log(e),0<e.length?(addToLog("getVRDisplays > 0"),addToLog(e[0].displayName),o.setupVRDisplay(e[0])):(addToLog("getVRDisplays = 0"),o.disableVR(!0,!1))})):(addToLog("NO VR"),o.disableVR(!1,!1))},this.setupVRDisplay=function(e){var t=this;addToLog("setupVRDisplay"),$("#b_webvr").on("click",function(){t.renderer.vr.setDevice(e),e.isPresenting?e.exitPresent():e.requestPresent([{source:t.renderer.domElement}]).then(function(){})}),$("#b_webvr").css("display:inline-block;"),$("#b_exit_webvr").on("click",function(){e.isPresenting?e.exitPresent():e.requestPresent([{source:t.renderer.domElement}]).then(function(){})})},this.setNewData=function(e){addToLog("setNewdata");var t=this;t.data=e;var o=document.querySelector(".videoTexture");if(o&&o.parentElement.removeChild(o),null==t.data.settings.lighting.root){trace("OBS: create lighting.root");t.data.settings.lighting.root={transform:{ar:{scale:{xyz:1}},vr:{scale:{xyz:1}}}}}t.projectFolder=_rootDirectory+"s/"+t.data.folder+"/"+t.data.url+"/"},this.reloadModel=function(){this.clearRootModel(),this.addSkyBox(),loadAB(this)},this.initScene=function(){var e=this;addToLog("initScene"),e.scene=new THREE.Scene,e.camera=new THREE.PerspectiveCamera,e.scene.add(e.camera),e.rootXR=new THREE.Group,e.scene.add(e.rootXR),e.viewFinder=new THREE.Group,e.rootXR.add(e.viewFinder),e.viewFinder.position.set(0,0,0),e.addSkyBox(),e.rootModel=new THREE.Group,e.rootXR.add(e.rootModel),"img"!=e.data.model.type?loadAB(e):e.initSceneImage()},this.initSceneImage=function(){var e=this.data.model.height/this.data.model.width,t=new THREE.PlaneGeometry(1,e),o=new THREE.Mesh(t,null);o.name="image";this.onModelLoaded(o,null,null),this.object.rotateX(THREE.Math.degToRad(-90))},this.addSkyBox=function(){var e=this,t=document.getElementById("vertexShader").textContent,o=document.getElementById("fragmentShader").textContent,n={topColor:{type:"c",value:new THREE.Color(e.data.settings.skyBox.top)},bottomColor:{type:"c",value:new THREE.Color(e.data.settings.skyBox.bottom)},offset:{type:"f",value:40},exponent:{type:"f",value:.6}},a=new THREE.SphereGeometry(700,32,15),i=new THREE.ShaderMaterial({uniforms:n,vertexShader:t,fragmentShader:o,side:THREE.BackSide});e.skyBox&&(e.scene.remove(e.skyBox),e.skyBox=null),e.skyBox=new THREE.Mesh(a,i),e.scene.add(e.skyBox)},this.clearScene=function(){for(;0<this.scene.children.length;)this.scene.remove(this.scene.children[0])},this.clearRootModel=function(){for(;0<this.rootModel.children.length;)this.rootModel.remove(this.rootModel.children[0])},this.onModelLoaded=function(e,t){var o=this;o.object=e,o.animations=t,o.updateLoader(100),_t1=performance.now();var n=parseInt(_t1-_t0);if(addToLog("model loaded "+o.data.model.type+" / t = "+n),null==o.renderer){try{o.renderer=new THREE.WebGLRenderer({antialias:!0,preserveDrawingBuffer:!0})}catch(e){console.error(e),addToLog("error renderer")}o.renderer.setClearColor(4210752,1),o.renderer.setSize(window.innerWidth,window.innerHeight-o.footerHeight),o.renderer.domElement.style.position="absolute",o.renderer.domElement.style.top="0",o.renderer.domElement.style.left="0",o.renderer.domElement.id="threejs",document.body.appendChild(this.renderer.domElement)}o.checkAvailability(),o.setupLighting();var a=function(e){switch(e.keyCode){case 38:case 87:moveForward=!0;break;case 37:case 65:moveLeft=!0;break;case 40:case 83:moveBackward=!0;break;case 39:case 68:moveRight=!0}},i=function(e){switch(e.keyCode){case 38:case 87:moveForward=!1;break;case 37:case 65:moveLeft=!1;break;case 40:case 83:moveBackward=!1;break;case 39:case 68:moveRight=!1;break;case 221:o.rootXR.translateY(.1);break;case 219:o.rootXR.translateY(-.1)}};document.removeEventListener("keydown",a),document.removeEventListener("keyup",i),document.addEventListener("keydown",a,!1),document.addEventListener("keyup",i,!1),o.loadTextures()},this.loadTextures=function(){var e=this;if(addToLog("loadTextures"),null!=e.object){e.textures=[];var t,o,n,a=e.data.materials.length;for(t=0;t<a;t++)e.textures.push({}),(n=(o=e.data.materials[t])["colorMap"])&&n.url&&e.nbTextureFiles++,(n=o["normalMap"])&&n.url&&e.nbTextureFiles++,(n=o["metalnessMap"])&&n.url&&e.nbTextureFiles++;if(0==e.nbTextureFiles)return addToLog("no textures to load"),void e.texturesLoaded();e.loadTexture(0,"colorMap")}},this.loadTexture=function(t,o){var n=this,e=n.data.materials[t],a=e[o];if("metalnessMap"!=o||"MeshStandardMaterial"==e.type)if(a){var i=n.projectFolder+a.url;if("mp4"==i.substr(i.lastIndexOf(".")+1)){var r=document.createElement("video"),s=!0;e.audio&&1==e.audio&&(s=!1,n.needAudioButton=!0),r.setAttribute("class","videoTexture"),r.setAttribute("height",128),r.setAttribute("width",128),r.autoplay=!0,r.loop=!0,s&&(r.muted=!0);var l=document.createElement("source");return l.setAttribute("src",i),l.setAttribute("type","video/mp4"),document.body.appendChild(r),r.appendChild(l),n.textures[t][o]=new THREE.VideoTexture(r),n.textures[t][o].wrapS=n.textures[t][o].wrapT=THREE.RepeatWrapping,n.textures[t][o].minFilter=THREE.LinearFilter,n.textures[t][o].magFilter=THREE.LinearFilter,n.textures[t][o].format=THREE.RGBFormat,n.loadNextTexture(t,o),void n.currentTextureFileIndex++}if(i){a.fileSize&&(n.texturesTotalFileSize+=a.fileSize);var d=new THREE.TextureLoader;n.textures[t][o]=d.load(i+"?r="+Math.random(),function(e){e.wrapS=e.wrapT=THREE.RepeatWrapping,n.loadNextTexture(t,o),n.currentTextureFileIndex++},function(){},function(){addToLog("error loading texture: "+t+" "+o),n.loadNextTexture(t,o),n.currentTextureFileIndex++})}else n.loadNextTexture(t,o)}else n.loadNextTexture(t,o);else n.loadNextTexture(t,o)},this.loadNextTexture=function(e,t){var o=this,n=100*o.currentTextureFileIndex/o.nbTextureFiles;if(n=parseInt(n),$("#textures .fill").css("width : "+n+"%"),"colorMap"!=t){if("normalMap"!=t)return"metalnessMap"==t?++e==o.textures.length?void o.texturesLoaded():void o.loadTexture(e,"colorMap"):void 0;o.loadTexture(e,"metalnessMap")}else o.loadTexture(e,"normalMap")},this.texturesLoaded=function(){$("#textures .fill").css("width:100%;"),$("#sceneLoader").css("display:none;");var e=this;addToLog("textures loaded"),e.addObject(),e.setupMaterials(),e.setupAnimations(),null!=e.data.settings.envMap&&e.setupEnvMap(e.data.settings.envMap.index),e.startLoop()},this.addObject=function(){var e=this,t=e.data.transform[e.currentMode],o=t.scale.xyz*e.data.transform.scaleToFit/10;e.rootModel.scale.set(o,o,o),e.rootModel.rotation.set(THREE.Math.degToRad(t.rotation.x),THREE.Math.degToRad(t.rotation.y),THREE.Math.degToRad(t.rotation.z)),e.rootModel.position.set(t.position.x/10,t.position.y/10,t.position.z/10-1);var n=new THREE.Vector3(t.position.x/10,t.position.y/10,t.position.z/10);new TWEEN.Tween(e.rootModel.position).to(n,1e3).easing(TWEEN.Easing.Quadratic.Out).start();e.rootModel.add(e.object)},this.setupMaterials=function(){var t,o=this;addToLog("setup Materials"),t=0,null!=o.object.geometry&&o.setupMaterial(o.object,t),t=1;var n=0;o.object.traverse(function(e){null!=e.geometry&&null!=e.geometry.attributes&&(o.setupMaterial(e,t),e.geometry.attributes.normal&&(n+=e.geometry.attributes.normal.count)),t++}),o.tris=parseInt(n/3*10/10)},this.setupMaterial=function(e,t){var o=this;1!=o.data.settings.unlit&&null!=o.data.settings.shadows&&1==o.data.settings.shadows.enabled&&(trace("receiveShadow true"),e.castShadow=!0,e.receiveShadow=!0);var n=!1;e.geometry.groups&&0<e.geometry.groups.length&&(n=!0);var a,i,r=o.data.materialsLinks,s=[];for(a=0;a<r.length;a++)if(null==!Array.isArray(r[a].mats)){if(trace("NEVER single mat"),alert("error single mat"),r[a].id==t){s[0]=r[a].m;break}}else if(r[a].id==t&&r[a].mats){for(i=0;i<r[a].mats.length;i++)s[i]=r[a].mats[i].m;break}var l,d=[],c=!1;"SkinnedMesh"==e.type&&(c=!0);var u=new THREE.MeshPhongMaterial({color:16776960,specular:2236962,shininess:0,skinning:c,shading:THREE.SmoothShading});if(0==s.length)return addToLog("- - -  no mat - - - "),void(e.material=u);for(a=0;a<s.length;a++){l=0,a<s.length&&(l=s[a]),l>=o.data.materials.length&&(l=0);var m=o.data.materials[l],p=m.type,h=m.shininess,g=m.color,v=m.specular;null==v&&(v=1118481);var f=m.reflectivity,E=m.doubleSide,b=m.colorMap,M=m.normalMap,y=m.metalnessMap,T=m.roughness,L=m.metalness,x=m.chroma;if("MeshStandardMaterial"==p&&(d[a]=new THREE.MeshStandardMaterial({color:g,skinning:c,roughness:T,metalness:L})),"MeshPhongMaterial"==p&&(d[a]=new THREE.MeshPhongMaterial({color:g,specular:v,reflectivity:f,shininess:h,skinning:c})),"MeshLambertMaterial"==p&&(d[a]=new THREE.MeshLambertMaterial({color:g,skinning:c})),"MeshBasicMaterial"==p&&(d[a]=new THREE.MeshBasicMaterial({color:g,skinning:c})),"MeshToonMaterial"==p&&(d[a]=new THREE.MeshToonMaterial({color:g,specular:v,reflectivity:f,shininess:h,skinning:c})),"VideoMaterial"==p)if(x){var w=o.textures[l].colorMap,R=new THREE.Color(m.chromaColor);d[a]=new THREE.ShaderMaterial({uniforms:{texture:{type:"t",value:w},color:{type:"c",value:R}},vertexShader:"varying mediump vec2 vUv;\nvoid main(void)\n{\nvUv = uv;\nmediump vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\ngl_Position = projectionMatrix * mvPosition;\n}",fragmentShader:"uniform mediump sampler2D texture;\nuniform mediump vec3 color;\nvarying mediump vec2 vUv;\nvoid main(void)\n{\n  mediump vec3 tColor = texture2D( texture, vUv ).rgb;\n  mediump float a = (length(tColor - color) - 0.5) * 7.0;\n  gl_FragColor = vec4(tColor, a);\n}",transparent:!0})}else d[a]=new THREE.MeshBasicMaterial({color:g,skinning:c});if(null==d[a]&&(trace("ERROR: m[i] is undefined > DEFAULT MAT"),d[a]=u),b&&b.url&&""!=b.url)"mp4"!=b.url.substr(b.url.lastIndexOf(".")+1)&&1==b.useAlpha&&(d[a].transparent=!0),d[a].map=o.textures[l].colorMap;M&&M.url&&""!=M.url&&(d[a].normalMap=o.textures[l].normalMap),"MeshStandardMaterial"==p&&y&&""!=y.url&&null!=y.url&&(d[a].metalnessMap=o.textures[l].metalnessMap,d[a].roughnessMap=o.textures[l].metalnessMap),d[a].side=1==E?THREE.DoubleSide:THREE.FrontSide}n&&1<s.length?e.material=d:e.material=d[0]},this.disableVR=function(e){var t;(addToLog("disableVR"),e)||(document.getElementById("VRNotSupported")||((t=document.createElement("div")).setAttribute("id","VRNotSupported"),t.innerHTML="VR mode is not supported on this browser",document.body.appendChild(t)));e&&((t=document.createElement("div")).setAttribute("id","VRNoHeadset"),t.innerHTML="Plug a VR headset to enable VR mode",document.body.appendChild(t));this.camera.position.set(0,0,2),this.rootXR.position.set(0,-1,0),this.isVRReady=!1,this.renderer.vr.enabled=!1},this.setupLighting=function(){var t=this;if(t.rootLighting)for(;0<t.rootLighting.children.length;)t.rootLighting.remove(t.rootLighting.children[0]);if(null!=t.data.settings.lighting.enableModelLights&&t.object.traverse(function(e){"PointLight"!=e.type&&"SpotLight"!=e.type||(e.visible=t.data.settings.lighting.enableModelLights)}),!t.data.settings.lighting.unlit){t.rootLighting=new THREE.Group,t.rootXR.add(t.rootLighting);var e,o=t.data.settings.lighting,n=o.root.transform[t.currentMode].scale.xyz;t.ambientLight=new THREE.AmbientLight,t.ambientLight.intensity=o.ambient.intensity,t.ambientLight.color=new THREE.Color(o.ambient.color),t.rootLighting.add(t.ambientLight);for(e=0;e<3;e++)t.light[e]=new THREE.PointLight,t.light[e].color=new THREE.Color(o.lights[e].color),t.light[e].intensity=o.lights[e].intensity,t.light[e].position.set(o.lights[e].position.x*n,o.lights[e].position.y*n,o.lights[e].position.z*n),t.rootLighting.add(t.light[e])}},this.setupEnvMap=function(e){var t=this;if(0==e)return t.renderer.gammaInput=!1,t.renderer.gammaOutput=!1,t.renderer.toneMapping=THREE.NoToneMapping,void(t.renderer.toneMappingExposure=1);t.renderer.gammaInput=!0,t.renderer.gammaOutput=!0,t.renderer.toneMapping=THREE.NoToneMapping,t.renderer.toneMappingExposure=1;var o=_rootDirectory+"assets/textures/envmap"+e+".jpg",n=(new THREE.TextureLoader).load(o,function(){addToLog("env map loaded"),n.mapping=THREE.SphericalReflectionMapping,t.object.traverse(function(e){e.geometry&&e.material&&(e.material.envMap=n,"MeshBasicMaterial"!=e.material.type&&"VideoMaterial"!=e.material.type||(e.material.envMap=null),e.material.needsUpdate=!0)})})},this.startLoop=function(){var o=this;_isDebug&&(addToLog(o.data.model.fileSize+" kb | "+o.tris+" tris"),o.data.model.fileSizeZ&&addToLog(o.data.model.fileSizeZ+" kbz"),addToLog("tex : "+o.texturesTotalFileSize+" kb")),o.renderer.vr.enabled=o.isVRReady,o.isVRReady||is.mobile(arguments),window.addEventListener("resize",function(){o.onWindowResize(o)},!1),o.onWindowResize(o),document.addEventListener("mousedown",function(){o.onDocumentMouseDown(o)},!1),document.addEventListener("keydown",function(e){o.onKeyDown(e,o)},!1),o.data.settings.tools&&1==o.data.settings.tools.enabled&&(_tools=new tools(o)),"undefined"!=typeof customTools&&customTools(o),addToLog("start Loop"),o.clock=new THREE.Clock;o.renderer.setAnimationLoop(function(){o.mixer&&o.mixer.update(o.clock.getDelta()),o.controls&&o.controls.update(o.clock.getDelta());var e=performance.now(),t=(e-prevTime)/1e3;prevTime=e,moveForward&&o.rootXR.translateZ(4*t),moveBackward&&o.rootXR.translateZ(-4*t),moveLeft&&o.rootXR.translateX(4*t),moveRight&&o.rootXR.translateX(-4*t),TWEEN.update(e),o.renderer.render(o.scene,o.camera)})},this.setupAnimations=function(){var e=this;if(e.animations&&e.data.settings.animations){e.mixer=new THREE.AnimationMixer(e.object);var t=e.data.settings.animations.activeIndex;e.playAnimation(t)}},this.playAnimation=function(e){-1!=e&&(this.mixer.stopAllAction(),this.mixer.clipAction(this.animations[e]).play())},this.onWindowResize=function(e){e.camera.aspect=window.innerWidth/(window.innerHeight-e.footerHeight),e.camera.updateProjectionMatrix(),e.renderer&&e.renderer.setSize(window.innerWidth,window.innerHeight-e.footerHeight)},this.onKeyDown=function(e,t){if(32==e.keyCode){t.camera.translateZ(-.08)}},this.onDocumentMouseDown=function(e){if(e.isVRReady){var t=new THREE.Vector3(0,0,.1);t.applyQuaternion(e.camera.quaternion),e.viewFinder.position.copy(t);var o=new THREE.Vector3;o.setFromMatrixPosition(e.viewFinder.matrixWorld),e.rootXR.position.set(o.x,e.rootXR.position.y,o.z)}},this.updateLoader=function(e){100<e&&(e=100),$("#model .fill").css("width : "+e+"%;")},this.isGeartouchpadPressed=function(){var e=navigator.getGamepads&&navigator.getGamepads();return null!=e&&(!!e[0]&&e[0].buttons[0].pressed)},this.setNewData(e),this.initScene()}function tools(f){this.c=f,this.toolsDom=null,this.toolsButtonsWrapper=null,this.photoModuleDom=null,this.animationsModuleDom=null,this.materialsModuleDom=null,this.eggModuleDom=null,this.photoData=null,this.setupTools=function(){addToMainLog("X setupTools");var e=this,t=e.c.data.settings.tools;null==t&&alert("tools undefined");var o=document.createElement("div");o.id="loadingTools",o.innerHTML="<p>please wait...</p>",document.body.appendChild(o),e.toolsDom=document.createElement("div"),e.toolsDom.id="tools",document.body.appendChild(e.toolsDom),e.toolsButtonsWrapper=document.createElement("div"),e.toolsButtonsWrapper.id="toolsButtonsWrapper",e.toolsDom.appendChild(e.toolsButtonsWrapper),1==t.photo.enabled&&e.photoModule(),1==t.animations.enabled&&e.animationsModule(),1==t.materials.enabled&&e.materialsModule(),t.egg&&1==t.egg.enabled&&(e.eggModule(),e.closeModules(),e.eggModuleDom.style.display="block",document.body.classList.add("eggModule")),document.onkeyup=function(e){if(13==e.which)return document.activeElement.blur(),!1}},this.closeModules=function(){var e=this;e.animationsModuleDom&&(e.animationsModuleDom.style.display="none"),e.materialsModuleDom&&(e.materialsModuleDom.style.display="none"),e.eggModuleDom&&(e.eggModuleDom.style.display="none"),e.photoModuleDom&&(e.photoModuleDom.style.display="none"),document.body.classList.remove("eggModule")},this.animationsModule=function(){var e=this;if(e.c.animations){var t=document.createElement("span");t.setAttribute("class","button"),t.innerHTML="animations",e.toolsButtonsWrapper.appendChild(t),e.animationsModuleDom=document.createElement("div"),e.animationsModuleDom.id="animationsModule",document.body.appendChild(e.animationsModuleDom);var o=document.createElement("span");o.setAttribute("class","b_close"),e.animationsModuleDom.appendChild(o);var n=document.createElement("h3");n.innerHTML="animations",e.animationsModuleDom.appendChild(n);var a,i,r=document.createElement("div");if(r.setAttribute("class","buttons"),e.animationsModuleDom.appendChild(r),f.animations)for(a=0;a<f.animations.length;a++)(i=document.createElement("span")).setAttribute("class","button"),i.setAttribute("data-index",a),i.innerHTML=excerpt(f.animations[a].name,13),r.appendChild(i),i.addEventListener(_clickOrTouch,function(){r.querySelectorAll(".button").forEach(function(e){e.classList.remove("active")}),this.classList.add("active");var e=this.getAttribute("data-index");f.playAnimation(e)});t.addEventListener("click",function(){"block"!=e.animationsModuleDom.style.display?(e.closeModules(),e.animationsModuleDom.style.display="block"):e.closeModules()}),o.addEventListener(_clickOrTouch,function(){e.closeModules()})}},this.materialsModule=function(){var e=this,t=e.c.data.settings.tools.materials,o=document.createElement("span");o.setAttribute("class","button"),o.innerHTML="colors",e.toolsButtonsWrapper.appendChild(o),e.materialsModuleDom=document.createElement("div"),e.materialsModuleDom.id="materialsModule",document.body.appendChild(e.materialsModuleDom);var n=document.createElement("span");n.setAttribute("class","b_close"),e.materialsModuleDom.appendChild(n);var a=document.createElement("h3");a.innerHTML="colors",e.materialsModuleDom.appendChild(a);var i,r,s,l,d,c,u,m=document.createElement("div");for(m.setAttribute("class","buttons"),e.materialsModuleDom.appendChild(m),i=l=0;i<f.data.materials.length;i++){for(u=f.data.materials[i].name,r=0;r<t.mats.length;r++)t.mats[r].name==u&&1==t.mats[r].enabled&&(c=f.data.materials[i].color.replace("#",""),s=document.createElement("span"),m.appendChild(s),s.setAttribute("class","button"),s.setAttribute("data-index",l),s.innerHTML=excerpt(u,13),s.style.background="#"+c,(d=document.createElement("input")).setAttribute("class","jscolor"),d.setAttribute("readonly","readonly"),d.setAttribute("data-index",i),d.setAttribute("value",c),s.appendChild(d),d.addEventListener(_clickOrTouch,function(){document.activeElement.blur()}),d.addEventListener("change",function(){var e=this.getAttribute("data-index"),t=this.value;f.data.materials[e].color="#"+t,this.parentElement.style.background="#"+t,f.setupMaterials()}));l++}window.jscolor.installByClassName("jscolor"),o.addEventListener("click",function(){"block"!=e.materialsModuleDom.style.display?(e.closeModules(),e.materialsModuleDom.style.display="block"):e.closeModules()}),n.addEventListener(_clickOrTouch,function(){e.closeModules()})},this.photoModule=function(){var e=this,t=document.createElement("span");t.id="b_takePhoto",t.setAttribute("class","button"),t.innerHTML='<img src="'+_rootDirectory+'assets/icon-camera.svg" alt="">',e.toolsDom.appendChild(t),e.photoModuleDom=document.createElement("div"),e.photoModuleDom.id="photoModule",document.body.appendChild(e.photoModuleDom);var o=document.createElement("span");o.setAttribute("class","b_close"),e.photoModuleDom.appendChild(o);var n=document.createElement("div");n.id="photoPreviewWrapper",e.photoModuleDom.appendChild(n);var a=document.createElement("img");a.id="photoPreview",a.setAttribute("class","preview"),n.appendChild(a);var i=document.createElement("div");i.id="photoForm",this.photoModuleDom.appendChild(i);var r=document.createElement("div");r.setAttribute("class","fields"),i.appendChild(r);var s=document.createElement("p"),l="Share the photo by email";_texts.shareThePhotoByEmail&&(l=_texts.shareThePhotoByEmail),s.innerHTML=l,r.appendChild(s);var d=document.createElement("input");d.id="photoEmail",d.setAttribute("placeholder","email"),d.setAttribute("type","email"),d.setAttribute("autocorrect","off"),d.setAttribute("autocapitalize","off"),r.appendChild(d);var c=document.createElement("span");c.id="b_sendPhoto",c.setAttribute("class","button"),c.innerHTML="send",r.appendChild(c),o.addEventListener("click",function(){e.closeModules()}),t.addEventListener(_clickOrTouch,function(){e.takePhoto()}),c.addEventListener(_clickOrTouch,function(){e.sendPhoto()})},this.eggModule=function(){function l(){var e,t,o;for(e=0;e<d*d;e++)o=16*parseInt(e/d),t=e%d*16,g.fillStyle=m[e].getAttribute("data-color"),g.fillRect(t,o,16,16);var n=g.getImageData(0,0,64,64);g.putImageData(n,0,0);var a=new THREE.Texture(h);a.wrapS=a.wrapT=THREE.RepeatWrapping,a.repeat.set(8,8),p.material.map=a,p.material.needsUpdate=!0,p.material.map.needsUpdate=!0}var e=this,t=document.createElement("span");t.setAttribute("class","button"),t.innerHTML="egg painter",e.toolsButtonsWrapper.appendChild(t),e.eggModuleDom=document.createElement("div"),e.eggModuleDom.id="eggModule",document.body.appendChild(e.eggModuleDom);var o,n=document.createElement("span");n.setAttribute("class","b_close"),e.eggModuleDom.appendChild(n);var a,i,d=4,r=document.createElement("div");for(r.id="palette",e.eggModuleDom.appendChild(r),o=0;o<8;o++){switch((a=document.createElement("div")).setAttribute("class","cell"),o){case 0:i="#ffb000";break;case 1:i="#59b1ff";break;case 2:i="#FF33CC";break;case 3:i="#80ff33";break;case 4:i="#ff0000";break;case 5:i="#ffffff";break;case 6:i="#909090";break;case 7:i="#202020"}a.setAttribute("data-color",i),a.style.background=i,r.appendChild(a)}var s=document.querySelectorAll("#palette .cell"),c=s[0].getAttribute("data-color");for(s[0].classList.add("active"),o=0;o<s.length;o++)s[o].addEventListener(_clickOrTouch,function(){var e;for(c=this.getAttribute("data-color"),e=0;e<s.length;e++)s[e].classList.remove("active");this.classList.add("active")});var u=document.createElement("div");for(u.id="patternGrid",e.eggModuleDom.appendChild(u),o=0;o<d*d;o++)(a=document.createElement("div")).setAttribute("class","cell"),a.setAttribute("data-color","#FFFFFF"),a.setAttribute("data-index",o),a.style.background="#FFFFFF",u.appendChild(a);var m=document.querySelectorAll("#patternGrid .cell");for(o=0;o<m.length;o++)m[o].addEventListener(_clickOrTouch,function(){c!=this.getAttribute("data-color")&&(this.style.background=c,this.setAttribute("data-color",c),l())});u.addEventListener("touchmove",function(e){var t=u.getBoundingClientRect().width/d,o=u.getBoundingClientRect().left,n=e.touches[0].pageX-o,a=window.innerHeight-e.touches[0].pageY-o,i=parseInt(n/t),r=d-1-parseInt(a/t),s=m[r*d+i];c!=s.getAttribute("data-color")&&(s.style.background=c,s.setAttribute("data-color",c),l())});var p=f.object.children[0],h=document.createElement("canvas");h.width=64,h.height=64;var g=h.getContext("2d");g.imageSmoothingEnabled=!1,g.webkitImageSmoothingEnabled=!1,t.addEventListener("click",function(){"block"!=e.eggModuleDom.style.display?(e.closeModules(),e.eggModuleDom.style.display="block",document.body.classList.add("eggModule")):e.closeModules()}),n.addEventListener(_clickOrTouch,function(){e.closeModules()});var v=document.createElement("span");v.id="b_takePhotoEgg",v.setAttribute("class","button"),v.innerHTML='<img src="'+_rootDirectory+'assets/icon-camera.svg" alt="">',e.eggModuleDom.appendChild(v),v.addEventListener(_clickOrTouch,function(){e.takePhoto()})},this.startLoading=function(){document.getElementById("loadingTools").style.display="block"},this.stopLoading=function(){document.getElementById("loadingTools").style.display="none"},this.takePhoto=function(){var t=this;document.getElementById("b_takePhoto").style.display="none",t.closeModules(),setTimeout(function(){var e=document.getElementById("threejs").toDataURL("image/jpeg",.8);t.photoData=new FormData,t.photoData.append("imgBase64",e),t.photoData.append("url",_projectURL),document.body.classList.contains("p")&&t.photoData.append("rotate",90),setTimeout(function(){t.photoModuleDom.style.display="block",document.body.classList.contains("p")?document.getElementById("photoPreviewWrapper").className="p":document.getElementById("photoPreviewWrapper").className=""},400),setTimeout(function(){document.getElementById("b_takePhoto").style.display="inline-block"},600),document.activeElement.blur(),document.getElementById("photoPreview").src=e},50)},this.sendPhoto=function(){var o=this;document.activeElement.blur();var e=document.getElementById("photoEmail").value;if(validateEmail(e)){document.getElementById("photoModule").className="",o.startLoading();var t=_rootDirectory+"d/take-photo.php",n=o.photoData;n.append("email",e);var a=new XMLHttpRequest;a.open("POST",t,!0),a.onload=function(){if(200<=a.status&&a.status<400){var e="Your photo has been sent";_texts.yourPhotoHasBeenSent&&(e=_texts.yourPhotoHasBeenSent);var t=JSON.parse(a.response);t.error&&(e="error : "+t.error),openModal(e),o.stopLoading()}else console.log("error a"),o.stopLoading(),openModal("error a")},a.onerror=function(){console.log("error b"),o.stopLoading(),openModal("error b")},a.send(n)}else openModal("Please enter a valid email")},this.setupTools()}function doChecks(){loadSceneData()}function loadSceneData(){var e=encodeURIComponent(document.referrer),t=_rootDirectory+"d/get-scene-front.php?url="+_projectURL+"&r="+e+"&vr";_isDebug&&(t+="&d");var o=new XMLHttpRequest;o.open("GET",t,!0),o.onload=function(){200<=o.status&&o.status<400?dataSceneLoaded(JSON.parse(o.responseText)):console.log("error a")},o.onerror=function(){console.log("error b")},o.send()}function dataSceneLoaded(e){var t=e.scenesData;if(1<t.length&&$("body").addClass("collection"),1<t.length){var o=document.createElement("div");o.id="sceneSelector",$("body").addClass("sceneSelector"),document.querySelector("footer").appendChild(o);var n,a,i,r=document.createElement("ul");for(o.appendChild(r),n=0;n<t.length;n++)i=_rootDirectory+"s/"+t[n].folder+"/"+t[n].url+"/"+t[n].preview,(a=document.createElement("li")).setAttribute("data-index",n),a.innerHTML='<img class="preview" src="'+i+'" alt=""/>',r.appendChild(a),a.addEventListener(_clickOrTouch,function(){startVR(this.getAttribute("data-index"),e),$("#sceneSelector li").attr("class",""),this.className="active"});$("#sceneSelector li").eq(0).attr("class","active")}startVR(0,e)}function startVR(e,t){addToLog("D: startVR "+e+" / "+t.scenesData.length),_isDebug&&console.log(t.scenesData);var o=t.scenesData[e];null==_xr?_xr=new vr(o):(_xr.setNewData(o),_xr.reloadModel()),$("#b_logo").on(_clickOrTouch,function(e){return e.preventDefault(),clickOnlogo(t.scenesData[0]),!1})}function playSound(){document.getElementById("pop").play()}function clickOnlogo(e){var t=e.settings.logoMenu;if(t){var o=t.moreButtons;if(o&&0<o.length){var n,a=0;for($("#logoMenu").css("display:block;"),$("#logoMenu>div").html(""),a=0;a<o.length;a++)""!=o[a].url&&null!=o[a].url&&(""==o[a].textParagraph&&(o[a].textParagraph="&nbsp;"),n="",n+="<p>"+o[a].textParagraph+"</p>",n+='<p><a class="button" href="'+o[a].url+'" target="_top">'+o[a].textButton+"</a></p>",$("#logoMenu>div").insertLast(n));return}}top.location=_rootDirectory}function openModal(e){var t=document.createElement("div");t.id="bgModal",t.innerHTML='<div id="alertModal"><p>'+e+'</p><div class="buttons"><span class="button ok">ok</span></div></div></div>',document.body.appendChild(t),document.querySelector("#alertModal .button.ok").addEventListener(_clickOrTouch,function(){var e=document.getElementById("bgModal");e&&e.parentElement.removeChild(e)})}var nano=function(e){return this.value=Array.prototype.slice.call(document.querySelectorAll(e)),this};nano.prototype={eq:function(e){return this.value=[this.value[e]],this},each:function(e){return[].forEach.call(this.value,e),this},css:function(t){return this.each(function(e){e.style.cssText=e.style.cssText+t})},cssdom:function(o){return this.each(function(e){for(var t in o)e.style[t]=o[t]})},attr:function(t,o){return this.each(function(e){e.setAttribute(t,o)})},getAttr:function(e){return this.value[0].getAttribute(e)},removeAttr:function(t){return this.each(function(e){e.removeAttribute(t)})},animate:function(t,o,n,a,i,r,s,l,d,c){return this.each(function(e){e.style.cssText=e.style.cssText+"transition: all "+t+"s ease-in-out; transform: scale("+o+") rotate("+n+"deg) rotateX("+a+"deg) rotateY("+i+"deg) translate("+r+"px, "+s+"px) skew("+l+"deg, "+d+"deg); opacity:"+c+";)"})},on:function(t,o){return this.each(function(e){e.addEventListener(t,o,!1)})},addClass:function(t){return this.each(function(e){e.classList?e.classList.add(t):e.className+=" "+t})},toggleClass:function(t){return this.each(function(e){e.classList.toggle(t)})},removeClass:function(t){return this.each(function(e){e.classList.remove(t)})},html:function(t){return this.each(function(e){e.innerHTML=t})},text:function(t){return this.each(function(e){e.innerText=t})},insertBefore:function(t){return this.each(function(e){e.insertAdjacentHTML("beforeBegin",t)})},insertAfter:function(t){return this.each(function(e){e.insertAdjacentHTML("afterEnd",t)})},insertFirst:function(t){return this.each(function(e){e.insertAdjacentHTML("afterBegin",t)})},insertLast:function(t){return this.each(function(e){e.insertAdjacentHTML("beforeEnd",t)})},empty:function(){return this.each(function(e){e.innerHTML=""})},offset:function(){return this.each(function(e){offset=e.getBoundingClientRect()})}};var $=function(e){return new nano(e)};!function(){if("performance"in window==0&&(window.performance={}),"now"in window.performance==0){var e=Date.now();performance.timing&&performance.timing.navigationStart&&(e=performance.timing.navigationStart),window.performance.now=function(){return Date.now()-e}}}();var _t0,_t1,controlsEnabled=!1,moveForward=!1,moveBackward=!1,moveLeft=!1,moveRight=!1,prevTime=performance.now(),velocity=new THREE.Vector3,direction=new THREE.Vector3,_tools=null,getArguments=function(){return arguments},_arguments=getArguments(),_xr=null;document.getElementById("mainLog")&&document.getElementById("mainLog").addEventListener(_clickOrTouch,function(){$("#mainLog").css("display:none;")}),$("#b_close_logoMenu").on("click",function(){$("#logoMenu").css("display:none;")}),doChecks();